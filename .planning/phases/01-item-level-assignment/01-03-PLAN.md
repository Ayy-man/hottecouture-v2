---
phase: 01-item-level-assignment
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/lib/board/useBoardFilters.ts
  - src/lib/board/useBoardData.ts
  - src/app/board/workload/page.tsx
autonomous: true

must_haves:
  truths:
    - "Board filters by item-level assignment (not order-level)"
    - "Each seamstress sees only THEIR assigned items"
    - "Workload page groups items by assigned seamstress"
  artifacts:
    - path: "src/lib/board/useBoardFilters.ts"
      provides: "Filter logic using assigned_seamstress_id"
      contains: "assigned_seamstress_id"
    - path: "src/lib/board/useBoardData.ts"
      provides: "Data fetching with assignment info"
      contains: "assigned_seamstress_id"
    - path: "src/app/board/workload/page.tsx"
      provides: "Workload view grouped by item assignment"
      contains: "assigned_seamstress_id"
  key_links:
    - from: "src/lib/board/useBoardFilters.ts"
      to: "garment_service.assigned_seamstress_id"
      via: "Filter comparison"
      pattern: "assigned_seamstress_id.*===|filter.*assigned_seamstress_id"
    - from: "src/lib/board/useBoardData.ts"
      to: "/api/orders"
      via: "API fetch with assignment data"
      pattern: "fetch.*orders|assigned_seamstress"
---

<objective>
Update board filtering and data fetching to use item-level assignment.

Purpose: Enable seamstresses to see only their assigned items (not entire orders) and enable the workload view to group items by assignee.

Output: Updated board hooks and workload page that filter/group by item-level assignment.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-item-level-assignment/01-02-SUMMARY.md

# Key files for current implementation:
@src/lib/board/useBoardFilters.ts
@src/lib/board/useBoardData.ts
@src/lib/board/types.ts
@src/app/board/workload/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update useBoardData to fetch assignment info</name>
  <files>src/lib/board/useBoardData.ts</files>
  <action>
Update the data fetching hook to include item-level assignment information.

Current code fetches from `task` table which has `assignee` VARCHAR. Change to:
1. Fetch `garment_service` data instead of (or in addition to) `task` table
2. Include `assigned_seamstress_id` and resolve staff name via join

**Changes to make:**

1. Update the Supabase query to fetch `garment_service` data:
```typescript
garments (
  id,
  type,
  garment_service (
    id,
    assigned_seamstress_id,
    stage,
    service:service_id (
      name
    )
  )
)
```

2. Join staff table to get names (or fetch separately and map).

3. Transform the data so `BoardOrder.garments[].services[]` includes:
   - `assigned_seamstress_id`
   - `assigned_seamstress_name` (resolved from staff table)

4. Update the `tasks` array transformation to pull from `garment_service` instead of deprecated `task` table:
```typescript
tasks: order.garments?.flatMap(g =>
  (g.garment_service || []).map(gs => ({
    id: gs.id,
    stage: gs.stage || 'pending',
    assignee: gs.assigned_seamstress_name, // For backward compat
    assigned_seamstress_id: gs.assigned_seamstress_id
  }))
) || []
```

IMPORTANT:
- Maintain backward compatibility with existing task-based code
- The `assignee` string field should still work (populate from staff name)
- Add new `assigned_seamstress_id` field alongside
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Open browser to `/board`
3. Check browser console for transformed orders
4. Verify each order has:
   - `tasks` array with `assigned_seamstress_id`
   - Tasks have both `assignee` (string) and `assigned_seamstress_id` (uuid)
  </verify>
  <done>
    - Data fetching includes garment_service with assigned_seamstress_id
    - Staff names are resolved and included
    - BoardOrder tasks have both assignee (name) and assigned_seamstress_id (uuid)
    - Backward compatibility maintained
  </done>
</task>

<task type="auto">
  <name>Task 2: Update useBoardFilters to filter by item assignment</name>
  <files>src/lib/board/useBoardFilters.ts</files>
  <action>
Update the filter logic to use item-level assignment (UUID) instead of order-level (string name).

**Changes to make:**

1. Update `BoardFilters` interface to support both:
```typescript
interface BoardFilters {
  // ... existing fields
  assignee?: string;  // Keep for backward compat (string name)
  assignedSeamstressId?: string;  // New: UUID-based filtering
}
```

2. Update the assignee filter logic:
```typescript
// Assignee filter - now uses item-level assignment
if (filters.assignedSeamstressId) {
  // Check if ANY garment_service in this order is assigned to this seamstress
  const hasAssignedItem = order.garments?.some(g =>
    g.services?.some(s => s.assigned_seamstress_id === filters.assignedSeamstressId)
  ) || order.tasks.some(t => t.assigned_seamstress_id === filters.assignedSeamstressId)

  if (!hasAssignedItem) {
    return false
  }
}

// Keep old string-based filter for backward compat
if (filters.assignee && !filters.assignedSeamstressId) {
  const assignees = order.tasks.map(t => t.assignee).filter(Boolean)
  if (!assignees.includes(filters.assignee)) {
    return false
  }
}
```

3. Consider adding a filter mode that shows ONLY the assigned items (not the whole order):
   - This would require additional transformation, may defer to Phase 6 "Manage Task"

IMPORTANT: The current behavior shows entire orders if ANY item matches. For Phase 1, this is acceptable. Phase 6 will add per-item management.
  </action>
  <verify>
1. Open `/board` page
2. Use the assignee filter dropdown
3. Select a seamstress
4. Verify:
   - Only orders with at least one item assigned to that seamstress appear
   - Orders with no assigned items (unassigned) appear when "Unassigned" filter is active
  </verify>
  <done>
    - Filter supports `assignedSeamstressId` (UUID-based)
    - Backward compatible with `assignee` (string-based)
    - Orders filter correctly based on item-level assignments
  </done>
</task>

<task type="auto">
  <name>Task 3: Update workload page to group by item assignment</name>
  <files>src/app/board/workload/page.tsx</files>
  <action>
Update the workload page to group and display items by their individual assignment.

**Current behavior:** Groups orders by order.assigned_to (order-level)
**New behavior:** Groups items (garment_services) by assigned_seamstress_id (item-level)

**Changes to make:**

1. Fetch orders using the updated useBoardData or direct API call with assignment info

2. Transform data to group by seamstress:
```typescript
interface WorkloadItem {
  garmentServiceId: string
  orderId: string
  orderNumber: number
  clientName: string
  garmentType: string
  serviceName: string
  stage: string
  dueDate?: string
}

interface SeamstressWorkload {
  seamstressId: string | null  // null = unassigned
  seamstressName: string
  items: WorkloadItem[]
  totalItems: number
}

// Group items by seamstress
const workloadBySeamstress = useMemo(() => {
  const groups: Map<string | null, SeamstressWorkload> = new Map()

  orders.forEach(order => {
    order.garments?.forEach(garment => {
      garment.services?.forEach(service => {
        const seamstressId = service.assigned_seamstress_id
        const seamstressName = service.assigned_seamstress_name || 'Unassigned'

        if (!groups.has(seamstressId)) {
          groups.set(seamstressId, {
            seamstressId,
            seamstressName,
            items: [],
            totalItems: 0
          })
        }

        groups.get(seamstressId)!.items.push({
          garmentServiceId: service.id,
          orderId: order.id,
          orderNumber: order.order_number,
          clientName: order.client_name,
          garmentType: garment.type,
          serviceName: service.service?.name || service.custom_service_name || 'Service',
          stage: service.stage || 'pending',
          dueDate: order.due_date
        })
        groups.get(seamstressId)!.totalItems++
      })
    })
  })

  return Array.from(groups.values())
}, [orders])
```

3. Update the UI to display:
   - Section for each seamstress (including "Unassigned")
   - Count of items per seamstress
   - List of items with order number, client, garment type, service, status

4. Add "Unassigned" section at top or bottom showing items with no seamstress

IMPORTANT: Keep the existing UI structure/styling, just change the data source from order-level to item-level grouping.
  </action>
  <verify>
1. Navigate to `/board/workload`
2. Verify:
   - Items are grouped by seamstress (not orders)
   - Each seamstress section shows their specific items
   - "Unassigned" section shows items with no assignee
   - Item count per seamstress is accurate
3. Assign an item to a different seamstress and refresh - verify it moves
  </verify>
  <done>
    - Workload page groups items by assigned_seamstress_id
    - Shows "Unassigned" section for items without assignment
    - Displays item count per seamstress
    - Items correctly move between sections when reassigned
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify the complete item-level assignment flow:

1. **Filter verification:**
   - Go to `/board`
   - Filter by a specific seamstress
   - Verify only orders with items assigned to that seamstress appear

2. **Workload verification:**
   - Go to `/board/workload`
   - Verify each seamstress section shows ONLY their assigned items
   - Verify "Unassigned" section exists

3. **Cross-order assignment verification:**
   - Create an order with 2 items
   - Assign Item 1 to Seamstress A, Item 2 to Seamstress B
   - Check workload page: Item 1 appears under A, Item 2 under B
   - Filter board by Seamstress A: Order appears (has their item)
   - Filter board by Seamstress B: Same order appears (has their item)

4. **Reassignment verification:**
   - Reassign Item 1 from A to B using API
   - Refresh workload page
   - Both items now under Seamstress B
</verification>

<success_criteria>
1. Board data includes item-level assignment info (assigned_seamstress_id)
2. Board filters use item-level assignment
3. Workload page groups by item assignment, not order assignment
4. "Unassigned" section visible for items without seamstress
5. Can assign Item 1 to Seamstress A and Item 2 to Seamstress B in same order
6. Each seamstress sees only THEIR items in workload view
</success_criteria>

<output>
After completion, create `.planning/phases/01-item-level-assignment/01-03-SUMMARY.md`
</output>
