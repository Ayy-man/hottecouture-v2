---
phase: 01-item-level-assignment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/0031_add_item_level_assignment.sql
  - supabase/migrations/0032_update_orders_rpc_assignment.sql
autonomous: true

must_haves:
  truths:
    - "garment_service table has assigned_seamstress_id UUID column"
    - "Existing order-level assignments are migrated to item-level"
    - "Index exists for assignment filtering performance"
  artifacts:
    - path: "supabase/migrations/0031_add_item_level_assignment.sql"
      provides: "Add assigned_seamstress_id column with FK to staff table"
      contains: "assigned_seamstress_id UUID REFERENCES staff"
    - path: "supabase/migrations/0032_update_orders_rpc_assignment.sql"
      provides: "Update RPC function to include assignment in JSON output"
      contains: "assigned_seamstress_id"
  key_links:
    - from: "garment_service.assigned_seamstress_id"
      to: "staff.id"
      via: "Foreign key constraint"
      pattern: "REFERENCES staff\\(id\\)"
---

<objective>
Add item-level assignment to the database schema.

Purpose: Enable different seamstresses to work on different items within the same order by moving assignment from order-level to garment_service-level.

Output: Two SQL migration files that add the new column and migrate existing data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-item-level-assignment/01-RESEARCH.md

# Key files for understanding current schema:
@supabase/migrations/0025_garment_service_is_task.sql
@supabase/migrations/0014_add_order_assigned_to.sql
@supabase/migrations/0024_staff_table_complete.sql
@supabase/migrations/0030_add_type_to_orders_rpc.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration for assigned_seamstress_id column</name>
  <files>supabase/migrations/0031_add_item_level_assignment.sql</files>
  <action>
Create a new SQL migration file that:

1. Adds `assigned_seamstress_id UUID REFERENCES staff(id)` column to `garment_service` table
2. Creates an index `idx_garment_service_assigned_seamstress` for performance
3. Migrates existing order-level assignments:
   - Join `garment_service` -> `garment` -> `order` -> `staff`
   - Match `order.assigned_to` (VARCHAR) to `staff.name` (case-insensitive, trimmed)
   - Set `garment_service.assigned_seamstress_id` to matched `staff.id`
4. Add a column comment documenting the purpose
5. Do NOT remove the old `order.assigned_to` column (backward compatibility)

IMPORTANT: Use case-insensitive matching with TRIM() to handle whitespace differences.
Use LEFT JOIN so records with no matching staff still get updated (NULL is fine).
The migration must be idempotent (safe to run multiple times).
  </action>
  <verify>
Run in Supabase SQL Editor:
```sql
-- Check column exists
SELECT column_name, data_type FROM information_schema.columns
WHERE table_name = 'garment_service' AND column_name = 'assigned_seamstress_id';

-- Check foreign key exists
SELECT conname FROM pg_constraint WHERE conname LIKE '%garment_service%staff%';

-- Check index exists
SELECT indexname FROM pg_indexes WHERE indexname = 'idx_garment_service_assigned_seamstress';

-- Check data migration worked (should show some non-null values)
SELECT COUNT(*) as total, COUNT(assigned_seamstress_id) as assigned FROM garment_service;
```
  </verify>
  <done>
    - Column `assigned_seamstress_id` exists with UUID type
    - Foreign key constraint to staff table exists
    - Index for filtering exists
    - Existing orders with assignments have their garment_services populated
  </done>
</task>

<task type="auto">
  <name>Task 2: Update RPC function to include assignment data</name>
  <files>supabase/migrations/0032_update_orders_rpc_assignment.sql</files>
  <action>
Update the `get_orders_with_details` RPC function to:

1. Include `assigned_seamstress_id` in the garment_service JSON object within the `services` array
2. Include resolved staff name as `assigned_seamstress_name` (JOIN to staff table)
3. Add optional parameter `p_assigned_seamstress_id UUID DEFAULT NULL` to filter orders that have any garment_service assigned to a specific seamstress

Base the changes on the existing function in `0030_add_type_to_orders_rpc.sql`.

The services array should include:
```json
{
  "garment_service_id": "...",
  "assigned_seamstress_id": "uuid-or-null",
  "assigned_seamstress_name": "Marie" or null,
  // ... existing fields
}
```

IMPORTANT:
- Use `DROP FUNCTION IF EXISTS` before CREATE OR REPLACE
- Maintain backward compatibility - existing queries should still work
- Include GRANT statements for authenticated and service_role
  </action>
  <verify>
Run in Supabase SQL Editor:
```sql
-- Test the function returns assignment data
SELECT * FROM get_orders_with_details(5, 0) LIMIT 1;

-- Check if garments->services JSON includes assignment fields
SELECT
  id,
  (garments::json->0->'services'->0->>'assigned_seamstress_id') as assignee_id,
  (garments::json->0->'services'->0->>'assigned_seamstress_name') as assignee_name
FROM get_orders_with_details(5, 0)
WHERE garments IS NOT NULL
LIMIT 3;
```
  </verify>
  <done>
    - RPC function returns `assigned_seamstress_id` and `assigned_seamstress_name` in services JSON
    - Optional filter by seamstress works
    - Existing queries still work (backward compatible)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Schema verification:
```sql
\d garment_service
-- Should show assigned_seamstress_id UUID with FK to staff
```

2. Data migration verification:
```sql
-- Count migrated assignments
SELECT COUNT(*) FROM garment_service WHERE assigned_seamstress_id IS NOT NULL;

-- Cross-check with original order assignments
SELECT o.order_number, o.assigned_to, s.name as migrated_to
FROM "order" o
JOIN garment g ON g.order_id = o.id
JOIN garment_service gs ON gs.garment_id = g.id
LEFT JOIN staff s ON s.id = gs.assigned_seamstress_id
WHERE o.assigned_to IS NOT NULL
LIMIT 10;
```

3. RPC function verification:
```sql
SELECT jsonb_pretty(garments) FROM get_orders_with_details(1, 0);
-- Should see assigned_seamstress_id and assigned_seamstress_name in services
```
</verification>

<success_criteria>
1. `garment_service.assigned_seamstress_id` column exists with proper FK
2. Index `idx_garment_service_assigned_seamstress` exists
3. Existing orders with `assigned_to` have their items migrated
4. RPC function returns assignment data in JSON
5. No errors when running migration multiple times (idempotent)
</success_criteria>

<output>
After completion, create `.planning/phases/01-item-level-assignment/01-01-SUMMARY.md`
</output>
