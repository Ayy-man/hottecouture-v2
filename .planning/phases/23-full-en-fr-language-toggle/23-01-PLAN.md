---
phase: 23-full-en-fr-language-toggle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/i18n/request.ts
  - src/app/layout.tsx
  - src/components/ui/language-toggle.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Language toggle is visible in the header on every page"
    - "Clicking EN or FR updates the NEXT_LOCALE cookie and triggers a re-render"
    - "All client components have access to translations via NextIntlClientProvider"
    - "Language preference persists across page navigation and browser refresh"
  artifacts:
    - path: "src/i18n/request.ts"
      provides: "Cookie-based locale resolution"
      contains: "cookies().get('NEXT_LOCALE')"
    - path: "src/app/layout.tsx"
      provides: "NextIntlClientProvider wrapping all children"
      contains: "NextIntlClientProvider"
    - path: "src/components/ui/language-toggle.tsx"
      provides: "Functional EN/FR toggle with cookie management"
      contains: "Cookies.set('NEXT_LOCALE'"
  key_links:
    - from: "src/components/ui/language-toggle.tsx"
      to: "NEXT_LOCALE cookie"
      via: "js-cookie Cookies.set()"
      pattern: "Cookies\\.set\\('NEXT_LOCALE'"
    - from: "src/i18n/request.ts"
      to: "NEXT_LOCALE cookie"
      via: "next/headers cookies()"
      pattern: "cookies\\(\\).*get\\('NEXT_LOCALE'\\)"
    - from: "src/app/layout.tsx"
      to: "NextIntlClientProvider"
      via: "getMessages() + provider wrapper"
      pattern: "NextIntlClientProvider.*messages"
---

<objective>
Set up the i18n foundation: install js-cookie, fix locale resolution to read from cookies, wrap root layout with NextIntlClientProvider, and implement a functional language toggle component.

Purpose: This is the prerequisite for all translation work. Without this foundation, useTranslations() hooks will fail in client components, locale switching won't work, and the toggle will remain non-functional.

Output: Working language toggle in header that switches between EN/FR, persists via cookie, and triggers full page re-render with new locale.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-full-en-fr-language-toggle/23-RESEARCH.md

@src/i18n/request.ts
@src/app/layout.tsx
@src/components/ui/language-toggle.tsx
@next.config.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install js-cookie and fix locale resolution</name>
  <files>
    package.json
    src/i18n/request.ts
  </files>
  <action>
    1. Run `npm install js-cookie` and `npm install --save-dev @types/js-cookie`

    2. Rewrite `src/i18n/request.ts` to read locale from the NEXT_LOCALE cookie:

    ```typescript
    import { getRequestConfig } from 'next-intl/server';
    import { cookies } from 'next/headers';

    const locales = ['en', 'fr'] as const;
    const defaultLocale = 'fr';

    export default getRequestConfig(async () => {
      const cookieStore = await cookies();
      const localeCookie = cookieStore.get('NEXT_LOCALE')?.value;

      const locale = localeCookie && locales.includes(localeCookie as any)
        ? localeCookie
        : defaultLocale;

      return {
        locale,
        messages: (await import(`../../locales/${locale}.json`)).default
      };
    });
    ```

    Key changes from current code:
    - Remove the `({ locale })` parameter (old API pattern that relies on middleware)
    - Add `cookies()` import from `next/headers`
    - Read NEXT_LOCALE cookie server-side
    - Return `locale` in the config object (required by next-intl v3)
    - Default to 'fr' if no cookie set

    3. Delete the `/src/messages/` directory if it exists (outdated translation copies):
    ```bash
    rm -rf src/messages/
    ```
  </action>
  <verify>
    - `npm ls js-cookie` shows js-cookie installed
    - `npx tsc --noEmit` compiles without errors on request.ts
    - `/src/messages/` directory no longer exists
  </verify>
  <done>
    js-cookie is in package.json dependencies, @types/js-cookie in devDependencies, request.ts reads locale from NEXT_LOCALE cookie with 'fr' fallback, old /src/messages/ directory deleted
  </done>
</task>

<task type="auto">
  <name>Task 2: Wrap layout with NextIntlClientProvider and implement language toggle</name>
  <files>
    src/app/layout.tsx
    src/components/ui/language-toggle.tsx
  </files>
  <action>
    1. Update `src/app/layout.tsx`:

    a. Make the default export function `async` (required for getMessages())
    b. Add imports:
       ```typescript
       import { NextIntlClientProvider } from 'next-intl';
       import { getMessages, getLocale } from 'next-intl/server';
       import { LanguageToggle } from '@/components/ui/language-toggle';
       ```
    c. Inside the async function body, before the return:
       ```typescript
       const locale = await getLocale();
       const messages = await getMessages();
       ```
    d. Set `<html lang={locale}>` instead of `<html lang='en'>`
    e. Wrap the body content with `<NextIntlClientProvider messages={messages}>` as the OUTERMOST wrapper inside `<body>`, wrapping `<ToastProvider>` and everything else.
    f. Add `<LanguageToggle />` to the header, in the desktop nav between the "Home" link and `<StaffIndicator />`:
       ```tsx
       <nav className='hidden md:flex items-center space-x-4'>
         <a href='/' className='text-sm font-medium transition-colors hover:text-primary'>Home</a>
         <LanguageToggle />
         <StaffIndicator />
       </nav>
       ```
    g. Also add `<LanguageToggle />` to the mobile header section:
       ```tsx
       <div className='flex md:hidden items-center gap-2'>
         <LanguageToggle />
         <StaffIndicator />
       </div>
       ```

    2. Rewrite `src/components/ui/language-toggle.tsx`:

    ```typescript
    'use client';

    import { Button } from '@/components/ui/button';
    import Cookies from 'js-cookie';
    import { useRouter } from 'next/navigation';
    import { useLocale } from 'next-intl';

    export function LanguageToggle() {
      const router = useRouter();
      const currentLocale = useLocale();

      const switchLocale = (locale: 'en' | 'fr') => {
        if (locale === currentLocale) return;
        Cookies.set('NEXT_LOCALE', locale, { expires: 365, path: '/' });
        router.refresh();
      };

      return (
        <div className="flex items-center">
          <Button
            variant={currentLocale === 'en' ? 'default' : 'ghost'}
            size="sm"
            className="h-7 px-2 text-xs rounded-r-none"
            onClick={() => switchLocale('en')}
          >
            EN
          </Button>
          <Button
            variant={currentLocale === 'fr' ? 'default' : 'ghost'}
            size="sm"
            className="h-7 px-2 text-xs rounded-l-none"
            onClick={() => switchLocale('fr')}
          >
            FR
          </Button>
        </div>
      );
    }
    ```

    Key design decisions:
    - Use `useLocale()` from next-intl instead of local state (single source of truth)
    - Use `router.refresh()` to trigger server re-render after cookie update
    - Cookie expires in 365 days with path='/' for persistence
    - Compact pill-style toggle (h-7 px-2 text-xs) fits header without crowding
    - Skip switching if already on selected locale (no unnecessary refresh)
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - `npm run build` completes successfully (layout is async, provider wraps correctly)
    - Language toggle component renders EN and FR buttons
  </verify>
  <done>
    Root layout is async, uses getMessages()/getLocale(), wraps all children with NextIntlClientProvider, renders LanguageToggle in both desktop and mobile header. Language toggle reads locale from next-intl context, writes NEXT_LOCALE cookie via js-cookie, calls router.refresh() to trigger server re-render.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Language toggle visible in header (desktop and mobile)
3. Clicking EN sets NEXT_LOCALE=en cookie and refreshes page
4. Clicking FR sets NEXT_LOCALE=fr cookie and refreshes page
5. Cookie persists across page navigation (check DevTools > Application > Cookies)
6. Refreshing the page preserves the selected language
</verification>

<success_criteria>
- js-cookie installed and typed
- request.ts reads NEXT_LOCALE cookie with 'fr' fallback
- layout.tsx wraps children with NextIntlClientProvider
- LanguageToggle component is functional (reads locale, writes cookie, refreshes)
- Toggle visible in header on desktop and mobile
- Build passes (npm run build)
</success_criteria>

<output>
After completion, create `.planning/phases/23-full-en-fr-language-toggle/23-01-SUMMARY.md`
</output>
