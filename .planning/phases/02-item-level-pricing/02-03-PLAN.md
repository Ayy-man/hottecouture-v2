---
phase: 02-item-level-pricing
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/components/board/order-detail-modal.tsx
autonomous: false

must_haves:
  truths:
    - "User can see estimated price (readonly) per item"
    - "User can edit final price per item"
    - "Order total updates after saving item price"
    - "Customer-facing documents show only prices (never time)"
  artifacts:
    - path: "src/components/board/order-detail-modal.tsx"
      provides: "Item-level price editing UI"
      contains: "final_price_cents"
  key_links:
    - from: "src/components/board/order-detail-modal.tsx"
      to: "/api/garment-service/[id]/price"
      via: "fetch PATCH request"
      pattern: "garment-service.*price"
---

<objective>
Add item-level price editing UI showing both estimated and final prices per item.

Purpose: Allow seamstresses to adjust final prices after work is completed, while preserving the original estimate for reference.

Output:
- Updated order-detail-modal with per-item price display and editing
- Estimated price shown as readonly
- Final price editable with inline save
- Order totals update automatically after price changes
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-item-level-pricing/02-RESEARCH.md
@.planning/phases/02-item-level-pricing/02-01-SUMMARY.md
@.planning/phases/02-item-level-pricing/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add item-level price editing to order-detail-modal</name>
  <files>src/components/board/order-detail-modal.tsx</files>
  <action>
Update `src/components/board/order-detail-modal.tsx` to add item-level price editing.

**1. Add new state variables** (after existing state declarations around line 47):
```typescript
// Item-level price editing state
const [editingServicePrice, setEditingServicePrice] = useState<string | null>(null);
const [editServicePriceCents, setEditServicePriceCents] = useState(0);
const [savingServicePrice, setSavingServicePrice] = useState<string | null>(null);
```

**2. Add price editing handlers** (after handleSavePrice function around line 323):
```typescript
// Item-level price editing handlers
const handleStartEditServicePrice = (serviceId: string, currentPriceCents: number) => {
  setEditingServicePrice(serviceId);
  setEditServicePriceCents(currentPriceCents);
};

const handleCancelEditServicePrice = () => {
  setEditingServicePrice(null);
  setEditServicePriceCents(0);
};

const handleSaveServicePrice = async (serviceId: string) => {
  setSavingServicePrice(serviceId);
  try {
    // Get current staff name from localStorage or default
    const staffName = localStorage.getItem('currentStaffName') || 'Staff';

    const response = await fetch(`/api/garment-service/${serviceId}/price`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        new_price_cents: editServicePriceCents,
        changed_by: staffName,
      }),
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Failed to update price');
    }

    const result = await response.json();

    // Update local state with new prices
    if (detailedOrder) {
      // Update the specific garment service price
      const updatedGarments = detailedOrder.garments.map((g: any) => ({
        ...g,
        services: g.services?.map((s: any) =>
          s.id === serviceId
            ? { ...s, final_price_cents: editServicePriceCents }
            : s
        ),
      }));

      // Update order totals from API response
      setDetailedOrder({
        ...detailedOrder,
        garments: updatedGarments,
        subtotal_cents: result.order.subtotal_cents,
        tax_cents: result.order.tax_cents,
        total_cents: result.order.total_cents,
      });
    }

    setEditingServicePrice(null);
    setEditServicePriceCents(0);
  } catch (error) {
    console.error('Error saving service price:', error);
    alert(error instanceof Error ? error.message : 'Failed to update price');
  } finally {
    setSavingServicePrice(null);
  }
};

// Helper to get the effective price for a service
const getServicePriceInfo = (service: any) => {
  const finalPrice = service.final_price_cents;
  const customPrice = service.custom_price_cents;
  const basePrice = service.service?.base_price_cents || 0;

  // Determine which price is active
  const activePriceCents = finalPrice ?? customPrice ?? basePrice;
  const estimatedPriceCents = customPrice ?? basePrice;
  const hasFinalPrice = finalPrice !== null && finalPrice !== undefined;

  return {
    activePriceCents,
    estimatedPriceCents,
    hasFinalPrice,
    totalCents: activePriceCents * (service.quantity || 1),
    estimatedTotalCents: estimatedPriceCents * (service.quantity || 1),
  };
};
```

**3. Update the services display section** (around line 838-905, inside the garment.services.map):

Replace the existing price display div (the one with "Price TBD") with this new structure:

```tsx
{/* Services for this garment - Updated with item-level pricing */}
{garment.services && garment.services.length > 0 && (
  <div className='mt-3 pt-3 border-t border-border'>
    <h5 className='text-sm font-medium text-blue-600 mb-2'>
      Services Required:
    </h5>
    <div className='space-y-2'>
      {garment.services.map((service: any, serviceIndex: number) => {
        const priceInfo = getServicePriceInfo(service);
        const isEditing = editingServicePrice === service.id;
        const isSaving = savingServicePrice === service.id;

        return (
          <div
            key={service.id || serviceIndex}
            className='bg-blue-50 rounded-lg p-3'
          >
            <div className='flex justify-between items-start'>
              <div className='flex-1'>
                <h6 className='font-medium text-foreground'>
                  {service.service?.name ||
                    service.custom_service_name ||
                    'Service'}
                </h6>
                {service.service?.description && (
                  <p className='text-sm text-muted-foreground mt-1'>
                    {service.service.description}
                  </p>
                )}
                {service.notes && (
                  <div className='mt-2'>
                    <span className='text-xs font-medium text-muted-foreground'>
                      Service Notes:
                    </span>
                    <p className='text-xs text-muted-foreground mt-1 bg-white rounded p-2'>
                      {service.notes}
                    </p>
                  </div>
                )}
              </div>
              <div className='text-right text-sm ml-4 min-w-[140px]'>
                <div className='text-muted-foreground'>
                  Qty: {service.quantity}
                </div>

                {/* Estimated Price (readonly) */}
                <div className='text-xs text-muted-foreground mt-1'>
                  Est: ${(priceInfo.estimatedTotalCents / 100).toFixed(2)}
                </div>

                {/* Final Price (editable) */}
                {isEditing ? (
                  <div className='mt-2 space-y-1'>
                    <div className='flex items-center gap-1'>
                      <span className='text-xs'>$</span>
                      <input
                        type='number'
                        step='0.01'
                        value={(editServicePriceCents / 100).toFixed(2)}
                        onChange={(e) => setEditServicePriceCents(
                          Math.round(parseFloat(e.target.value || '0') * 100)
                        )}
                        className='w-20 px-2 py-1 text-xs border border-blue-300 rounded focus:ring-2 focus:ring-blue-500'
                        disabled={isSaving}
                        autoFocus
                      />
                    </div>
                    <div className='flex gap-1'>
                      <Button
                        size='sm'
                        onClick={() => handleSaveServicePrice(service.id)}
                        disabled={isSaving}
                        className='bg-blue-600 hover:bg-blue-700 text-xs h-6 px-2'
                      >
                        {isSaving ? '...' : 'Save'}
                      </Button>
                      <Button
                        size='sm'
                        variant='outline'
                        onClick={handleCancelEditServicePrice}
                        disabled={isSaving}
                        className='text-xs h-6 px-2'
                      >
                        Cancel
                      </Button>
                    </div>
                  </div>
                ) : (
                  <div className='mt-1'>
                    <div className='flex items-center justify-end gap-1'>
                      <span className={`font-medium ${priceInfo.hasFinalPrice ? 'text-green-700' : 'text-foreground'}`}>
                        ${(priceInfo.totalCents / 100).toFixed(2)}
                      </span>
                      {priceInfo.hasFinalPrice && (
                        <span className='text-[10px] text-green-600 font-medium'>FINAL</span>
                      )}
                    </div>
                    <Button
                      size='sm'
                      variant='ghost'
                      onClick={() => handleStartEditServicePrice(
                        service.id,
                        priceInfo.activePriceCents
                      )}
                      className='text-xs text-blue-600 hover:text-blue-800 h-5 px-1 mt-1'
                    >
                      Edit Price
                    </Button>
                  </div>
                )}

                {service.service?.estimated_minutes && (
                  <div className='text-xs text-muted-foreground mt-1'>
                    Est time:{' '}
                    {Math.floor(service.service.estimated_minutes / 60)}h{' '}
                    {service.service.estimated_minutes % 60}m
                    {service.quantity > 1 && ` x ${service.quantity}`}
                  </div>
                )}
              </div>
            </div>
          </div>
        );
      })}
    </div>
  </div>
)}
```

**4. Update the reset effect** (around line 171-183) to include new state:
```typescript
useEffect(() => {
  if (!isOpen) {
    setEditingGarmentId(null);
    setEditingNotes('');
    setSavingNotes(null);
    setEditingTimeGarmentId(null);
    setEditingTimeHours(0);
    setEditingTimeMinutes(0);
    setSavingTime(null);
    setRackPosition('');
    setCustomRackPosition('');
    // Reset item-level price editing
    setEditingServicePrice(null);
    setEditServicePriceCents(0);
    setSavingServicePrice(null);
  }
}, [isOpen]);
```

**Key UI behaviors:**
- Each service shows "Est: $XX.XX" (estimated price, always visible, grayed out)
- Below that shows the active price with "Edit Price" button
- When final price is set, shows green "FINAL" badge
- Clicking "Edit Price" shows inline number input
- Save calls the API and updates order totals automatically
- Cancel returns to display mode
  </action>
  <verify>
    - TypeScript compiles: `npx tsc --noEmit src/components/board/order-detail-modal.tsx`
    - No lint errors: `npx eslint src/components/board/order-detail-modal.tsx`
  </verify>
  <done>
    - Each item service shows estimated price (readonly)
    - Each item service has editable final price with "Edit Price" button
    - Final prices marked with green "FINAL" badge
    - Saving updates order totals automatically
    - State resets when modal closes
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Item-level price editing in the order detail modal:
    - Per-service estimated price display (readonly, grayed)
    - Per-service final price with "Edit Price" button
    - Inline editing with Save/Cancel
    - Order total auto-updates after price change
    - Green "FINAL" badge when final price is set
  </what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev`
    2. Open the board view and click on any order
    3. In the order detail modal, scroll to the "Services Required" section
    4. Verify each service shows:
       - "Est: $XX.XX" in gray (the estimated/original price)
       - The active price in black/green
       - "Edit Price" button
    5. Click "Edit Price" on any service
    6. Change the price to a different value
    7. Click "Save"
    8. Verify:
       - The service now shows "FINAL" badge in green
       - The order total at the bottom updated automatically
    9. Refresh the page and reopen the order
    10. Verify the final price persisted

    NOTE: Database migrations must be run first (0033 and 0034).
  </how-to-verify>
  <resume-signal>Type "approved" if pricing works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Order detail modal shows both estimated and final prices per item
2. Can edit final price with inline UI
3. Order total updates after saving
4. Final prices marked with "FINAL" badge
5. Price changes persisted to database
</verification>

<success_criteria>
- User can modify item price after invoice is created (ARCH-05)
- Order total updates automatically when item price changes (ARCH-06)
- Price change logged with audit trail (via API from Plan 02)
- UI shows both estimated price (readonly) and final price (editable)
- Customer-facing documents show only prices (never time) - already the case
</success_criteria>

<output>
After completion, create `.planning/phases/02-item-level-pricing/02-03-SUMMARY.md`
</output>
