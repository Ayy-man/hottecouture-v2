---
phase: 02-item-level-pricing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/0033_add_final_price_cents.sql
  - supabase/migrations/0034_create_price_change_log.sql
  - src/lib/types/database.ts
  - src/lib/pricing/types.ts
autonomous: true

must_haves:
  truths:
    - "garment_service table has final_price_cents column"
    - "price_change_log table exists for audit trail"
    - "TypeScript types include final_price_cents and PriceChangeLog"
  artifacts:
    - path: "supabase/migrations/0033_add_final_price_cents.sql"
      provides: "final_price_cents column on garment_service"
      contains: "ALTER TABLE garment_service"
    - path: "supabase/migrations/0034_create_price_change_log.sql"
      provides: "Audit log table for price changes"
      contains: "CREATE TABLE"
    - path: "src/lib/types/database.ts"
      provides: "TypeScript types for new columns/tables"
      contains: "final_price_cents"
    - path: "src/lib/pricing/types.ts"
      provides: "Extended PricingItem interface"
      contains: "final_price_cents"
  key_links:
    - from: "supabase/migrations/0033"
      to: "garment_service table"
      via: "ALTER TABLE"
      pattern: "final_price_cents"
    - from: "supabase/migrations/0034"
      to: "price_change_log"
      via: "CREATE TABLE"
      pattern: "price_change_log"
---

<objective>
Add database schema and TypeScript types for item-level pricing with audit trail.

Purpose: Enable storing final prices per item (separate from estimated prices) and logging all price changes for accountability.

Output:
- Migration adding `final_price_cents` column to `garment_service`
- Migration creating `price_change_log` audit table
- Updated TypeScript types in `database.ts` and `pricing/types.ts`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-item-level-pricing/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migrations for final_price and audit log</name>
  <files>
    supabase/migrations/0033_add_final_price_cents.sql
    supabase/migrations/0034_create_price_change_log.sql
  </files>
  <action>
Create two SQL migration files following the patterns in 02-RESEARCH.md:

**Migration 0033_add_final_price_cents.sql:**
- Add `final_price_cents INTEGER` column to `garment_service` table (NULLABLE - existing rows will have NULL)
- Add comment explaining: "Final price after work completion. NULL = use custom_price_cents or base price. Editable post-invoice."
- Create partial index `idx_garment_service_has_final_price` on id WHERE final_price_cents IS NOT NULL

**Migration 0034_create_price_change_log.sql:**
- Create `price_change_log` table with columns:
  - id: UUID PRIMARY KEY DEFAULT gen_random_uuid()
  - created_at: TIMESTAMPTZ DEFAULT NOW() NOT NULL
  - garment_service_id: UUID NOT NULL REFERENCES garment_service(id) ON DELETE CASCADE
  - order_id: UUID NOT NULL REFERENCES "order"(id) ON DELETE CASCADE
  - changed_by: VARCHAR(100) NOT NULL (staff name or 'system')
  - old_price_cents: INTEGER (NULL if first final price set)
  - new_price_cents: INTEGER NOT NULL
  - reason: TEXT (optional)
- Create indexes: idx_pcl_garment_service, idx_pcl_order, idx_pcl_created_at DESC, idx_pcl_changed_by
- Enable RLS with policy for authenticated users
- Add table comment for documentation

Use exact SQL from research document.
  </action>
  <verify>
    Check migrations exist and have valid SQL syntax:
    - `ls supabase/migrations/0033*.sql supabase/migrations/0034*.sql`
    - Review SQL for syntax errors
  </verify>
  <done>
    - 0033 migration adds final_price_cents column to garment_service
    - 0034 migration creates price_change_log table with all indexes and RLS
    - Both files have documentation comments
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TypeScript types for final_price and price_change_log</name>
  <files>
    src/lib/types/database.ts
    src/lib/pricing/types.ts
  </files>
  <action>
**In src/lib/types/database.ts:**

1. Add `final_price_cents: number | null;` to garment_service Row type (after custom_price_cents)
2. Add `final_price_cents?: number | null;` to garment_service Insert type
3. Add `final_price_cents?: number | null;` to garment_service Update type
4. Add new price_change_log table type to the Tables object:
```typescript
price_change_log: {
  Row: {
    id: string;
    created_at: string;
    garment_service_id: string;
    order_id: string;
    changed_by: string;
    old_price_cents: number | null;
    new_price_cents: number;
    reason: string | null;
  };
  Insert: {
    id?: string;
    created_at?: string;
    garment_service_id: string;
    order_id: string;
    changed_by: string;
    old_price_cents?: number | null;
    new_price_cents: number;
    reason?: string | null;
  };
  Update: {
    // Audit logs should not be updated - leave empty or minimal
  };
};
```
5. Add type aliases at the bottom:
```typescript
export type PriceChangeLog = Tables<'price_change_log'>;
export type PriceChangeLogInsert = Database['public']['Tables']['price_change_log']['Insert'];
```

**In src/lib/pricing/types.ts:**

1. Add `final_price_cents: number | null;` to PricingItem interface (after custom_price_cents)
2. Add new types for price update operations:
```typescript
export interface PriceUpdateRequest {
  garment_service_id: string;
  new_price_cents: number;
  changed_by: string;
  reason?: string;
}

export interface PriceUpdateResponse {
  success: boolean;
  garment_service: {
    id: string;
    final_price_cents: number;
  };
  order: {
    id: string;
    subtotal_cents: number;
    tax_cents: number;
    total_cents: number;
  };
  audit_log_id: string | null;
}
```
  </action>
  <verify>
    TypeScript compiles without errors:
    - `npx tsc --noEmit src/lib/types/database.ts src/lib/pricing/types.ts`
  </verify>
  <done>
    - garment_service type includes final_price_cents in Row, Insert, Update
    - price_change_log type added with Row, Insert, Update
    - PriceChangeLog and PriceChangeLogInsert aliases exported
    - PricingItem interface includes final_price_cents
    - PriceUpdateRequest and PriceUpdateResponse types added
  </done>
</task>

</tasks>

<verification>
1. Migration files exist in supabase/migrations/
2. TypeScript types compile without errors
3. final_price_cents appears in both database.ts and pricing/types.ts
4. price_change_log table type exists in database.ts
</verification>

<success_criteria>
- Database schema ready for final_price_cents column and audit log table
- TypeScript types updated to match new schema
- No TypeScript compilation errors
- Ready for API route implementation in next plan
</success_criteria>

<output>
After completion, create `.planning/phases/02-item-level-pricing/02-01-SUMMARY.md`
</output>
