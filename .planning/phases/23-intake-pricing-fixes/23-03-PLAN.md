---
phase: 23-intake-pricing-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/intake/pricing-step.tsx
  - src/components/ui/calendar.tsx
  - src/components/ui/popover.tsx
autonomous: true

must_haves:
  truths:
    - "Tax (TPS/TVQ) recalculates automatically when total is overridden"
    - "Overriding total back-calculates subtotal and recalculates TPS (5%) and TVQ (9.975%)"
    - "Date picker opens as an inline popup calendar instead of native HTML5 date input"
    - "Calendar displays in French and disables dates before tomorrow"
  artifacts:
    - path: "src/components/intake/pricing-step.tsx"
      provides: "Tax recalculation on total override and inline calendar date picker"
      contains: "taxRate"
    - path: "src/components/ui/calendar.tsx"
      provides: "Calendar UI component wrapping react-day-picker"
    - path: "src/components/ui/popover.tsx"
      provides: "Popover UI component wrapping @radix-ui/react-popover"
  key_links:
    - from: "pricing-step.tsx total override handler"
      to: "calculation state (tps_cents, tvq_cents, tax_cents)"
      via: "back-calculation from overridden total"
      pattern: "taxRate|1\\.14975|tps_cents.*tvq_cents"
    - from: "pricing-step.tsx Calendar"
      to: "data.due_date"
      via: "onSelect handler formatting date"
      pattern: "Calendar.*onSelect|format.*yyyy-MM-dd"
---

<objective>
Fix tax recalculation when total is overridden and replace the native date input with an inline calendar popup.

Purpose: When a seamstress overrides the total price, the tax line items (TPS/TVQ) stay stale showing the original calculated values, leading to incorrect balance due. The native HTML5 date picker is clunky on iPad and inconsistent across browsers. An inline calendar popup provides better UX.

Output: Tax auto-recalculates on total override. Date picker opens as a popup calendar with French locale.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-intake-pricing-fixes/23-RESEARCH.md

@src/components/intake/pricing-step.tsx
@src/lib/pricing/calcTotal.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Recalculate tax when total is overridden and install calendar dependencies</name>
  <files>src/components/intake/pricing-step.tsx, src/components/ui/calendar.tsx, src/components/ui/popover.tsx</files>
  <action>
  **Part A: Fix tax recalculation on total override**

  In `src/components/intake/pricing-step.tsx`, the total override handler (lines 470-474) currently saves the override value via `onTotalOverrideChange?.(cents > 0 ? cents : null)` but does NOT recalculate the tax display. The `calculation` state retains the original `tps_cents`, `tvq_cents`, and `tax_cents` values.

  When the user overrides the total and clicks "Enregistrer", recalculate the displayed tax breakdown:

  1. In the "Enregistrer" button onClick handler (lines 470-474), after computing `cents`, add tax recalculation:

  ```typescript
  onClick={() => {
    const dollars = parseFloat(editTotalValue) || 0;
    const cents = Math.round(dollars * 100);
    if (cents > 0) {
      // Back-calculate tax from overridden total
      // Total = taxable * 1.14975 where taxable = subtotal + rush_fee
      // TPS = 5%, TVQ = 9.975%, combined tax rate = 14.975%
      const taxRate = 1.14975;
      const taxableAmount = Math.round(cents / taxRate);
      const tps_cents = Math.round(taxableAmount * 0.05);
      const tvq_cents = Math.round(taxableAmount * 0.09975);
      const tax_cents = tps_cents + tvq_cents;
      const rush_fee_cents = data.rush
        ? data.rush_fee_type === 'large' ? 6000 : 3000
        : 0;
      const subtotal_cents = Math.max(0, taxableAmount - rush_fee_cents);

      // Update displayed calculation with recalculated values
      setCalculation({
        subtotal_cents,
        rush_fee_cents,
        tax_cents,
        tps_cents,
        tvq_cents,
        total_cents: cents,
      });
      onTotalOverrideChange?.(cents);
    } else {
      onTotalOverrideChange?.(null);
    }
    setIsEditingTotal(false);
  }}
  ```

  2. Also update the "Réinitialiser" button (lines 483-486) to recalculate back to original values when reset:

  The reset button currently calls `onTotalOverrideChange?.(null)`. After this, the useEffect that calculates pricing (lines 99-153) will re-run on the next render cycle because `data` or `garments` changed. However, since `onTotalOverrideChange?.(null)` does NOT trigger a garments/services change, the `calculation` state may stay with the overridden values.

  Fix: When resetting, explicitly recalculate the original pricing. The simplest approach is to keep a reference to the original calculation. Add state:
  ```typescript
  const [originalCalculation, setOriginalCalculation] = useState<any>(null);
  ```

  In the useEffect where `calculatePricing().then(calculation => { setCalculation(calculation); })` (line 150-152), also save the original: `setOriginalCalculation(calculation);`

  Then in the reset button:
  ```typescript
  onClick={() => {
    if (originalCalculation) {
      setCalculation(originalCalculation);
    }
    onTotalOverrideChange?.(null);
    setIsEditingTotal(false);
  }}
  ```

  **Part B: Install calendar/popover dependencies and create components**

  Run:
  ```bash
  npm install react-day-picker @radix-ui/react-popover
  ```

  Then create `src/components/ui/calendar.tsx`:
  ```typescript
  'use client';

  import * as React from 'react';
  import { DayPicker } from 'react-day-picker';

  export type CalendarProps = React.ComponentProps<typeof DayPicker>;

  function Calendar({
    className,
    classNames,
    showOutsideDays = true,
    ...props
  }: CalendarProps) {
    return (
      <DayPicker
        showOutsideDays={showOutsideDays}
        className={`p-3 ${className || ''}`}
        classNames={{
          months: 'flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0',
          month: 'space-y-4',
          caption: 'flex justify-center pt-1 relative items-center',
          caption_label: 'text-sm font-medium',
          nav: 'space-x-1 flex items-center',
          nav_button: 'h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100 inline-flex items-center justify-center rounded-md border border-input',
          nav_button_previous: 'absolute left-1',
          nav_button_next: 'absolute right-1',
          table: 'w-full border-collapse space-y-1',
          head_row: 'flex',
          head_cell: 'text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]',
          row: 'flex w-full mt-2',
          cell: 'h-9 w-9 text-center text-sm p-0 relative',
          day: 'h-9 w-9 p-0 font-normal inline-flex items-center justify-center rounded-md hover:bg-accent hover:text-accent-foreground cursor-pointer',
          day_range_end: 'day-range-end',
          day_selected: 'bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground',
          day_today: 'bg-accent text-accent-foreground',
          day_outside: 'text-muted-foreground opacity-50',
          day_disabled: 'text-muted-foreground opacity-50 cursor-not-allowed hover:bg-transparent',
          day_hidden: 'invisible',
          ...classNames,
        }}
        {...props}
      />
    );
  }
  Calendar.displayName = 'Calendar';

  export { Calendar };
  ```

  Create `src/components/ui/popover.tsx`:
  ```typescript
  'use client';

  import * as React from 'react';
  import * as PopoverPrimitive from '@radix-ui/react-popover';

  const Popover = PopoverPrimitive.Root;
  const PopoverTrigger = PopoverPrimitive.Trigger;

  const PopoverContent = React.forwardRef<
    React.ElementRef<typeof PopoverPrimitive.Content>,
    React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
  >(({ className, align = 'center', sideOffset = 4, ...props }, ref) => (
    <PopoverPrimitive.Portal>
      <PopoverPrimitive.Content
        ref={ref}
        align={align}
        sideOffset={sideOffset}
        className={`z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 ${className || ''}`}
        {...props}
      />
    </PopoverPrimitive.Portal>
  ));
  PopoverContent.displayName = PopoverPrimitive.Content.displayName;

  export { Popover, PopoverTrigger, PopoverContent };
  ```

  Note: The project already has `date-fns` (v3) in package.json. The `fr` locale from `date-fns/locale` will be used for French calendar display.
  </action>
  <verify>
  Run `npm install react-day-picker @radix-ui/react-popover` and then `npx tsc --noEmit`. Override a total price in the pricing step, verify the TPS/TVQ lines update to match the new total. Click "Réinitialiser", verify tax values return to original.
  </verify>
  <done>Tax recalculates when total is overridden (TPS and TVQ update proportionally). Calendar and Popover UI components created. Dependencies installed.</done>
</task>

<task type="auto">
  <name>Task 2: Replace native date input with inline calendar popup</name>
  <files>src/components/intake/pricing-step.tsx</files>
  <action>
  In `src/components/intake/pricing-step.tsx`, replace the native `<input type="date">` (lines 244-250) with a Calendar + Popover combo.

  **Imports to add** at the top of the file:
  ```typescript
  import { Calendar } from '@/components/ui/calendar';
  import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
  import { format, parseISO } from 'date-fns';
  import { fr } from 'date-fns/locale';
  ```

  **State to add** (near other state declarations):
  ```typescript
  const [datePickerOpen, setDatePickerOpen] = useState(false);
  ```

  **Replace the date input** (lines 244-250):
  ```tsx
  <input
    type='date'
    value={data.due_date || ''}
    onChange={e => handleInputChange('due_date', e.target.value)}
    min={getMinDate()}
    className='w-full px-3 py-2 text-sm border border-border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-h-[44px] touch-manipulation'
  />
  ```

  With:
  ```tsx
  <Popover open={datePickerOpen} onOpenChange={setDatePickerOpen}>
    <PopoverTrigger asChild>
      <button
        type="button"
        className="w-full px-3 py-2 text-sm border border-border rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent min-h-[44px] touch-manipulation text-left flex items-center justify-between"
      >
        <span className={data.due_date ? 'text-foreground' : 'text-muted-foreground'}>
          {data.due_date
            ? format(parseISO(data.due_date), 'PPP', { locale: fr })
            : 'Choisir une date'}
        </span>
        <svg className="w-4 h-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
      </button>
    </PopoverTrigger>
    <PopoverContent className="w-auto p-0" align="start">
      <Calendar
        mode="single"
        selected={data.due_date ? parseISO(data.due_date) : undefined}
        onSelect={(date) => {
          if (date) {
            handleInputChange('due_date', format(date, 'yyyy-MM-dd'));
            setDatePickerOpen(false);
          }
        }}
        disabled={(date) => {
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          tomorrow.setHours(0, 0, 0, 0);
          return date < tomorrow;
        }}
        locale={fr}
      />
    </PopoverContent>
  </Popover>
  ```

  The `getMinDate()` function (lines 159-164) is no longer needed for the input `min` attribute, but keep it in the codebase for reference. The `disabled` prop on Calendar achieves the same effect.

  **Key details:**
  - `format(parseISO(data.due_date), 'PPP', { locale: fr })` shows dates like "14 février 2026"
  - `mode="single"` for single date selection
  - `locale={fr}` renders month names and day names in French
  - `disabled` callback prevents selecting dates before tomorrow (same logic as `getMinDate()`)
  - Popover closes automatically when a date is selected
  - The trigger button maintains the same 44px touch target and styling as the old input
  </action>
  <verify>
  Run `npx tsc --noEmit` to verify TypeScript compiles. In dev mode, navigate to the pricing step. Click on the date field - verify a calendar popup appears. Verify month/day names are in French. Select a date - verify it populates and the popover closes. Verify dates before tomorrow are grayed out.
  </verify>
  <done>Date picker opens as an inline popup calendar with French locale. Past dates disabled. Selecting a date closes the popup and updates the due date field.</done>
</task>

</tasks>

<verification>
1. Open intake flow, add a garment with services, proceed to pricing step
2. Verify tax lines show TPS (5%) and TVQ (9.975%)
3. Click "Modifier" on total, enter a different amount, click "Enregistrer"
4. Verify TPS and TVQ update to match the new total (total / 1.14975 * 0.05 for TPS, * 0.09975 for TVQ)
5. Click "Réinitialiser" - verify tax returns to original calculated values
6. Click on the due date field - verify calendar popup opens in French
7. Verify past dates are grayed out, month/day names in French
8. Select a date - verify it shows formatted French date and popover closes
9. Run `npx tsc --noEmit` - must compile clean
</verification>

<success_criteria>
- Tax (TPS/TVQ) recalculates when total is overridden
- Reset returns tax to original values
- Date picker shows inline popup calendar (not native HTML input)
- Calendar displays in French (month names, day names)
- Past dates are disabled
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/23-intake-pricing-fixes/23-03-SUMMARY.md`
</output>
