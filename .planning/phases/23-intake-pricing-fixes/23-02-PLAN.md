---
phase: 23-intake-pricing-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/intake/garment-services-step.tsx
autonomous: true

must_haves:
  truths:
    - "User can click on a service price in the current garment's service list to edit it inline"
    - "Edited price updates the line total and garment subtotal immediately"
    - "User can add a custom service with name and price via an 'Ajouter un service personnalisé' button in the service selection area"
    - "Custom service gets added to the current garment's service list"
  artifacts:
    - path: "src/components/intake/garment-services-step.tsx"
      provides: "Inline price editing for service rows and custom service creation inline form"
      contains: "editingPrice"
  key_links:
    - from: "src/components/intake/garment-services-step.tsx inline price edit"
      to: "currentGarment.services[].customPriceCents"
      via: "updatePrice handler"
      pattern: "customPriceCents.*Math.round"
    - from: "src/components/intake/garment-services-step.tsx custom service form"
      to: "currentGarment.services array"
      via: "addServiceToCurrentGarment or direct push"
      pattern: "customService|customServiceName"
---

<objective>
Enable inline price editing in the services step and allow creating custom services during intake.

Purpose: Seamstresses need to adjust service prices on the spot (e.g., charge more for complex work) and occasionally add one-off custom services that don't exist in the catalog. Currently there's no way to edit prices or add custom services during intake.

Output: Editable price fields on service rows and an inline "add custom service" form in the service selection area.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-intake-pricing-fixes/23-RESEARCH.md

@src/components/intake/garment-services-step.tsx
@src/components/board/order-detail-modal.tsx (reference for existing inline edit pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add inline price editing to service rows in garment-services-step</name>
  <files>src/components/intake/garment-services-step.tsx</files>
  <action>
  Add inline price editing to the service rows shown after a service is added to the current garment. The service rows are rendered in the "Section 3: Current Garment Summary" area of `garment-services-step.tsx`.

  **State to add** (near the other state declarations around line 107):
  ```typescript
  const [editingPriceIndex, setEditingPriceIndex] = useState<number | null>(null);
  const [editPriceValue, setEditPriceValue] = useState('');
  ```

  **Handler to add** (near updateQty, updateAssignment handlers around line 490):
  ```typescript
  const updatePrice = (serviceIndex: number, newPriceCents: number) => {
    const updatedServices = [...(currentGarment.services || [])];
    const svc = updatedServices[serviceIndex];
    if (svc) {
      svc.customPriceCents = Math.max(0, newPriceCents);
      setCurrentGarment({ ...currentGarment, services: updatedServices });
    }
    setEditingPriceIndex(null);
  };
  ```

  **UI change:** Find the service row rendering in the current garment summary section. The service rows display price as read-only text. Each service row currently shows the price like `formatCurrency(svc.customPriceCents || 0)`. Make the price tappable/clickable to enter edit mode.

  For each service row in the current garment, the price display should be:

  ```tsx
  {editingPriceIndex === index ? (
    <div className="flex items-center gap-1">
      <span className="text-xs text-muted-foreground">$</span>
      <input
        type="text"
        inputMode="decimal"
        value={editPriceValue}
        onChange={e => {
          const value = e.target.value.replace(/[^0-9.]/g, '');
          setEditPriceValue(value);
        }}
        onBlur={() => {
          const dollars = parseFloat(editPriceValue) || 0;
          updatePrice(index, Math.round(dollars * 100));
        }}
        onKeyDown={e => {
          if (e.key === 'Enter') {
            const dollars = parseFloat(editPriceValue) || 0;
            updatePrice(index, Math.round(dollars * 100));
          }
          if (e.key === 'Escape') {
            setEditingPriceIndex(null);
          }
        }}
        className="w-16 px-1 py-0.5 text-sm border border-primary rounded text-right focus:ring-1 focus:ring-primary"
        autoFocus
      />
    </div>
  ) : (
    <button
      type="button"
      onClick={() => {
        setEditingPriceIndex(index);
        setEditPriceValue(((svc.customPriceCents || 0) / 100).toFixed(2));
      }}
      className="text-sm font-medium text-primary-600 hover:underline cursor-pointer"
      title="Cliquer pour modifier le prix"
    >
      {formatCurrency(svc.customPriceCents || 0)}
    </button>
  )}
  ```

  The line total (price x qty) should update immediately in the garment subtotal display (already computed via `currentGarmentSubtotal` memo on line 305-311).

  Important: The price edit is per-unit. The display should show unit price (editable) and the line total = unitPrice * qty (read-only). The `customPriceCents` field stores the per-unit price.

  Search for where service rows are rendered in the current garment display section. Look for patterns like `currentGarment.services?.map` or rendering of the services list with qty controls, assignment dropdown, time estimate, and remove button. Make the price in each row clickable to enter edit mode using the pattern above.

  Both the mobile (flex-col) and desktop (flex-row) layouts of the service row should support the price editing.
  </action>
  <verify>
  Run `npx tsc --noEmit` to verify TypeScript compiles. In dev mode, add a service to a garment, then tap/click on the price to verify it becomes an editable input. Type a new price, press Enter or blur, and confirm the subtotal updates.
  </verify>
  <done>Service prices in the current garment's service list are clickable and editable inline. Price changes update the line total and garment subtotal immediately.</done>
</task>

<task type="auto">
  <name>Task 2: Add inline custom service creation in service selection area</name>
  <files>src/components/intake/garment-services-step.tsx</files>
  <action>
  Add an "Ajouter un service personnalisé" button at the bottom of the service grid/list in `garment-services-step.tsx`. When clicked, it reveals an inline form for creating a one-off custom service.

  **State to add** (near existing state declarations):
  ```typescript
  const [showAddCustomService, setShowAddCustomService] = useState(false);
  const [customServiceName, setCustomServiceName] = useState('');
  const [customServicePriceValue, setCustomServicePriceValue] = useState('');
  ```

  **Handler to add:**
  ```typescript
  const handleAddCustomService = () => {
    const name = customServiceName.trim();
    if (!name) return;

    const priceDollars = parseFloat(customServicePriceValue) || 0;
    const priceCents = Math.round(priceDollars * 100);

    if (priceCents <= 0) {
      alert('Le prix doit être supérieur à 0');
      return;
    }

    // Check for duplicate name in current garment services
    const isDuplicate = currentGarment.services?.some(
      s => (s.serviceName || '').toLowerCase() === name.toLowerCase()
    );
    if (isDuplicate) {
      alert(`Le service "${name}" existe déjà dans cet article`);
      return;
    }

    // Add as a custom service directly to the current garment
    // Use a generated ID since this is not from the service catalog
    const customService: GarmentService = {
      serviceId: `custom_${nanoid(8)}`,
      serviceName: name,
      qty: 1,
      customPriceCents: priceCents,
      customServiceName: name,
      assignedSeamstressId: null,
      estimatedMinutes: 0,
    };

    setCurrentGarment({
      ...currentGarment,
      services: [...(currentGarment.services || []), customService],
    });

    // Reset form
    setCustomServiceName('');
    setCustomServicePriceValue('');
    setShowAddCustomService(false);
  };
  ```

  **UI placement:** After the service grid/list (after the closing div of the grid view around line 905 and the closing table around line 964), but still inside the Section 2 card, add:

  ```tsx
  {/* Add Custom Service */}
  <div className="border-t border-border pt-3 mt-3">
    {showAddCustomService ? (
      <div className="space-y-2 p-3 bg-muted/50 rounded-lg">
        <input
          type="text"
          value={customServiceName}
          onChange={e => setCustomServiceName(e.target.value)}
          placeholder="Nom du service..."
          className="w-full px-3 py-2 border border-border rounded-lg text-sm min-h-[44px] focus:ring-2 focus:ring-primary-500"
          autoFocus
          onKeyDown={e => {
            if (e.key === 'Escape') {
              setShowAddCustomService(false);
              setCustomServiceName('');
              setCustomServicePriceValue('');
            }
          }}
        />
        <div className="flex items-center gap-2">
          <span className="text-sm text-muted-foreground">$</span>
          <input
            type="text"
            inputMode="decimal"
            value={customServicePriceValue}
            onChange={e => {
              const value = e.target.value.replace(/[^0-9.]/g, '');
              setCustomServicePriceValue(value);
            }}
            placeholder="Prix"
            className="w-24 px-3 py-2 border border-border rounded-lg text-sm min-h-[44px] focus:ring-2 focus:ring-primary-500"
            onKeyDown={e => {
              if (e.key === 'Enter') handleAddCustomService();
              if (e.key === 'Escape') {
                setShowAddCustomService(false);
                setCustomServiceName('');
                setCustomServicePriceValue('');
              }
            }}
          />
        </div>
        <div className="flex gap-2">
          <button
            type="button"
            onClick={() => {
              setShowAddCustomService(false);
              setCustomServiceName('');
              setCustomServicePriceValue('');
            }}
            className="flex-1 px-3 py-2 bg-muted text-muted-foreground rounded-lg text-sm min-h-[44px] touch-manipulation"
          >
            Annuler
          </button>
          <button
            type="button"
            onClick={handleAddCustomService}
            disabled={!customServiceName.trim() || !customServicePriceValue}
            className="flex-1 px-3 py-2 bg-primary-500 text-white rounded-lg text-sm min-h-[44px] touch-manipulation disabled:opacity-50"
          >
            Ajouter
          </button>
        </div>
      </div>
    ) : (
      <button
        type="button"
        onClick={() => setShowAddCustomService(true)}
        className="w-full px-3 py-2 text-sm text-primary-600 hover:bg-muted/50 rounded-lg flex items-center gap-2 min-h-[44px] touch-manipulation"
      >
        <Plus className="w-4 h-4" />
        <span>Ajouter un service personnalisé...</span>
      </button>
    )}
  </div>
  ```

  This button should appear in BOTH grid and list views, after the service listing. Place it inside the Section 2 CardContent but after the conditional grid/list rendering.

  The custom service gets a `custom_` prefixed ID using nanoid so it's distinguishable from catalog services. The `customServiceName` field stores the display name. The service is added directly to the current garment without creating it in the database catalog (it's a one-off).

  Note: `Plus` icon is already imported from lucide-react at line 17.
  </action>
  <verify>
  Run `npx tsc --noEmit` to verify TypeScript compiles. In dev mode, navigate to garment services step, click "Ajouter un service personnalisé", fill in name and price, click Ajouter. Verify the custom service appears in the current garment's service list with the correct name and price.
  </verify>
  <done>Custom service creation inline form works: user can type a service name and price, click Ajouter, and the custom service appears in the current garment's service list ready for assignment and time estimation.</done>
</task>

</tasks>

<verification>
1. Open intake flow, select garment type, add a catalog service
2. Click on the service price in the current garment summary - verify it becomes editable
3. Change the price, press Enter - verify subtotal updates
4. Click "Ajouter un service personnalisé" button below the service grid
5. Enter "Broderie spéciale" at $45.00, click Ajouter
6. Verify the custom service appears in the current garment's service list with correct price
7. Run `npx tsc --noEmit` - must compile clean
</verification>

<success_criteria>
- Service prices clickable and editable inline in service rows
- Price changes reflect immediately in line totals and garment subtotal
- "Ajouter un service personnalisé" button visible below service grid/list
- Custom service form accepts name + price and adds to current garment
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/23-intake-pricing-fixes/23-02-SUMMARY.md`
</output>
