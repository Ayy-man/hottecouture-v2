---
phase: 27-role-based-access-control-seamstress-view-filtering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/orders/route.ts
  - src/app/board/page.tsx
  - src/components/navigation/mobile-bottom-nav.tsx
autonomous: true
requirements:
  - RBAC-01
  - RBAC-02
  - RBAC-06

must_haves:
  truths:
    - "Seamstress logged in via PIN sees only orders with items assigned to them on the board"
    - "Seamstress does not see Nouvelle Commande button, export buttons, assignee filter, or workload/archived links on board"
    - "Seamstress mobile bottom nav shows only Board and Calendar (no Intake, Clients, Chat)"
    - "Manager/admin sees full unfiltered board with all buttons and navigation"
  artifacts:
    - path: "src/app/api/orders/route.ts"
      provides: "API-level seamstress filtering via p_assigned_seamstress_id RPC param"
      contains: "p_assigned_seamstress_id"
    - path: "src/app/board/page.tsx"
      provides: "Board page with role-conditional UI elements"
      contains: "isSeamstress"
    - path: "src/components/navigation/mobile-bottom-nav.tsx"
      provides: "Role-filtered mobile navigation"
      contains: "useStaffSession"
  key_links:
    - from: "src/app/board/page.tsx"
      to: "src/app/api/orders/route.ts"
      via: "fetch with seamstressId query param"
      pattern: "seamstressId"
    - from: "src/app/api/orders/route.ts"
      to: "supabase.rpc('get_orders_with_details')"
      via: "p_assigned_seamstress_id param forwarding"
      pattern: "p_assigned_seamstress_id.*seamstressId"
---

<objective>
Wire API-level board filtering for seamstresses, hide admin-only UI elements on the board page, and restrict mobile navigation.

Purpose: Seamstresses should only see orders relevant to them and navigate only to allowed pages. This is the core access control layer.
Output: Board page with DB-level filtering by seamstress, conditional board UI, and role-filtered mobile nav.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/27-role-based-access-control-seamstress-view-filtering/27-RESEARCH.md
@src/app/api/orders/route.ts
@src/app/board/page.tsx
@src/components/navigation/mobile-bottom-nav.tsx
@src/components/staff/staff-session-provider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add seamstressId param to Orders API and wire board page fetch</name>
  <files>src/app/api/orders/route.ts, src/app/board/page.tsx</files>
  <action>
**Orders API (`src/app/api/orders/route.ts`):**
1. Read `seamstressId` from `searchParams.get('seamstressId')`
2. Pass it to the RPC call: `p_assigned_seamstress_id: seamstressId || null`
3. The `get_orders_with_details` RPC already accepts this UUID param (migration 0040) and filters orders where at least one `garment_service.assigned_seamstress_id` matches. No RPC changes needed.
4. Also apply seamstress filter to the count query if seamstressId is provided — join with garment_service to count only orders with matching assignments. For simplicity, when seamstressId is provided, get count from the `orders` array length instead of a separate count query (since pagination is not critical for the filtered seamstress view).

**Board page (`src/app/board/page.tsx`):**
1. Import `useStaffSession` from `@/components/staff`
2. At component top: `const { currentStaff } = useStaffSession();`
3. Derive: `const isSeamstress = currentStaff?.staffRole === 'seamstress';`
4. In the `fetchOrders` function (or wherever `/api/orders` is called), append `&seamstressId=${currentStaff.staffId}` to the URL when `isSeamstress && currentStaff?.staffId`
5. Hide the following UI elements when `isSeamstress` is true:
   - The "Nouvelle Commande" button/link (link to /intake)
   - The `MoreHorizontal` dropdown menu (3-dot menu containing Workload, Archived, Export links)
   - The `AssigneeFilter` dropdown (seamstresses are already filtered — they don't need this)
   - The "Export Work List" fixed button (`WorklistExport` component at bottom-left)
6. Seamstresses CAN still drag-move orders on kanban (keep DnD enabled)
7. Seamstresses CAN still use the `PipelineFilter` (status column filter) — they need to see their orders by status

Use `{!isSeamstress && (...)}` pattern for hiding elements. Do NOT use CSS display:none — use conditional JSX rendering.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Read the modified files to confirm:
   - API route reads `seamstressId` and passes to RPC
   - Board page conditionally appends `seamstressId` to fetch URL
   - Board page wraps admin-only elements in `{!isSeamstress && (...)}`
  </verify>
  <done>
- API accepts `seamstressId` query param and forwards to `p_assigned_seamstress_id` in RPC
- Board page sends `seamstressId` when logged-in staff is a seamstress
- Seamstress board hides: Nouvelle Commande, 3-dot menu, AssigneeFilter, WorklistExport
- Manager/admin board is unchanged (full UI, no seamstressId param sent)
  </done>
</task>

<task type="auto">
  <name>Task 2: Filter mobile bottom nav by staff role</name>
  <files>src/components/navigation/mobile-bottom-nav.tsx</files>
  <action>
1. Import `useStaffSession` from `@/components/staff` (the barrel export)
2. Inside `MobileBottomNav`, get the staff session: `const { currentStaff } = useStaffSession();`
3. Derive: `const isSeamstress = currentStaff?.staffRole === 'seamstress';`
4. Define allowed paths for seamstresses: `const SEAMSTRESS_NAV = ['/board', '/calendar'];`
5. Filter nav items: `const visibleItems = isSeamstress ? navItems.filter(item => SEAMSTRESS_NAV.includes(item.href)) : navItems;`
6. Replace `navItems.map(...)` with `visibleItems.map(...)` in the JSX

This is safe because `MobileBottomNav` is already `'use client'` and `StaffSessionProvider` wraps the entire app in layout.tsx. The `useStaffSession()` hook will work correctly here.

For the case where `currentStaff` is null (not logged in), show all nav items (the AuthGuard handles redirecting unauthenticated users separately).
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Read the modified file to confirm:
   - `useStaffSession` is imported
   - Nav items are filtered based on `isSeamstress`
   - Only Board and Calendar visible for seamstresses
  </verify>
  <done>
- Seamstress mobile nav shows only Board and Calendar
- Manager/admin mobile nav shows all 5 items (Board, Intake, Clients, Calendar, Chat)
- Non-authenticated users see full nav (AuthGuard handles access separately)
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles clean: `npx tsc --noEmit`
2. Board page: when `staffRole === 'seamstress'`, fetch URL includes `seamstressId` param
3. Board page: admin-only elements wrapped in `{!isSeamstress && (...)}`
4. Orders API: reads `seamstressId` and passes as `p_assigned_seamstress_id` to RPC
5. Mobile nav: seamstress sees Board + Calendar only
6. No changes to manager/admin experience
</verification>

<success_criteria>
- Seamstress sees only their assigned orders on the board (API-level filtering)
- Board page hides intake, export, filter, and menu buttons for seamstresses
- Mobile nav restricted to Board + Calendar for seamstresses
- Manager/admin experience completely unchanged
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/27-role-based-access-control-seamstress-view-filtering/27-01-SUMMARY.md`
</output>
