---
phase: 27-role-based-access-control-seamstress-view-filtering
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/calendar/page.tsx
  - src/app/board/workload/page.tsx
  - src/app/intake/page.tsx
  - src/app/clients/page.tsx
  - src/app/archived/page.tsx
  - src/app/dashboard/page.tsx
autonomous: true
requirements:
  - RBAC-04
  - RBAC-05
  - RBAC-07

must_haves:
  truths:
    - "Seamstress calendar shows only their own tasks and unassigned tasks"
    - "Seamstress workload page shows only their own utilization gauge and unassigned pool"
    - "Seamstress is redirected to /board when navigating to /intake, /clients, /archived, or /dashboard"
    - "Manager/admin calendar, workload, and all pages work unchanged"
  artifacts:
    - path: "src/app/calendar/page.tsx"
      provides: "Calendar with seamstress task filtering"
      contains: "isSeamstress"
    - path: "src/app/board/workload/page.tsx"
      provides: "Workload page with seamstress-only gauge view"
      contains: "isSeamstress"
    - path: "src/app/intake/page.tsx"
      provides: "Intake page with seamstress redirect guard"
      contains: "router.replace"
    - path: "src/app/clients/page.tsx"
      provides: "Clients page with seamstress redirect guard"
      contains: "router.replace"
    - path: "src/app/archived/page.tsx"
      provides: "Archived page with seamstress redirect guard"
      contains: "router.replace"
    - path: "src/app/dashboard/page.tsx"
      provides: "Dashboard page with seamstress redirect guard"
      contains: "router.replace"
  key_links:
    - from: "src/app/calendar/page.tsx"
      to: "useStaffSession()"
      via: "filter allTasks by currentStaff.staffId"
      pattern: "seamstressId.*currentStaff"
    - from: "src/app/board/workload/page.tsx"
      to: "useStaffSession()"
      via: "filter staffMembers by currentStaff.staffId"
      pattern: "isSeamstress.*staffId"
---

<objective>
Filter calendar and workload views for seamstresses, and add redirect guards on restricted pages.

Purpose: Seamstresses should see only their own work context (calendar tasks, workload gauge) and be prevented from accessing admin-only pages.
Output: Filtered calendar/workload for seamstresses, redirect guards on intake/clients/archived/dashboard.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/27-role-based-access-control-seamstress-view-filtering/27-RESEARCH.md
@src/app/calendar/page.tsx
@src/app/board/workload/page.tsx
@src/app/intake/page.tsx
@src/app/clients/page.tsx
@src/app/archived/page.tsx
@src/app/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Filter calendar tasks for seamstresses</name>
  <files>src/app/calendar/page.tsx</files>
  <action>
The calendar page already accesses `currentStaff` via `useStaffSession()`.

1. Derive: `const isSeamstress = currentStaff?.staffRole === 'seamstress';`
2. Create a filtered tasks memo. Find where `allTasks` is used for rendering calendar events (likely a `useMemo` or inline computation that feeds into the calendar grid). Add a filtering step:

```typescript
const filteredTasks = useMemo(() => {
  if (!isSeamstress) return allTasks;
  return allTasks.filter(t =>
    t.seamstressId === currentStaff?.staffId || !t.seamstressId
  );
}, [allTasks, isSeamstress, currentStaff?.staffId]);
```

3. Replace all downstream usages of `allTasks` with `filteredTasks` — specifically wherever tasks are mapped to calendar events/cells, the week view computation, and the day detail view.
4. The existing `unassignedTasks` section (filters `!t.seamstressId`) should remain visible for seamstresses — they can pick up unassigned work.
5. Do NOT change any member/staff filter dropdowns visibility — if there are member filter controls, hide them for seamstresses since filtering is already applied:
   - If there's a staff/member selector dropdown, wrap with `{!isSeamstress && (...)}`
6. Keep the calendar navigation (date range picker, prev/next buttons) fully functional for seamstresses.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Read the modified file to confirm:
   - `isSeamstress` derived from `currentStaff.staffRole`
   - `filteredTasks` memo filters by `currentStaff.staffId` or unassigned
   - All task rendering uses `filteredTasks` instead of `allTasks`
  </verify>
  <done>
- Seamstress calendar shows only tasks assigned to them + unassigned tasks
- Unassigned pool visible (seamstresses can pick up work)
- Manager/admin calendar shows all tasks (unchanged)
- TypeScript compiles clean
  </done>
</task>

<task type="auto">
  <name>Task 2: Filter workload page for seamstresses and add redirect guards to restricted pages</name>
  <files>src/app/board/workload/page.tsx, src/app/intake/page.tsx, src/app/clients/page.tsx, src/app/archived/page.tsx, src/app/dashboard/page.tsx</files>
  <action>
**Workload page (`src/app/board/workload/page.tsx`):**

The workload page already accesses `currentStaff` via `useStaffSession()`.

1. Derive: `const isSeamstress = currentStaff?.staffRole === 'seamstress';`
2. Filter the staff members gauge list: where staff gauges are rendered (likely a `.map()` over staff members), filter to show only the current seamstress's gauge:
   ```typescript
   const visibleStaff = isSeamstress
     ? staffMembers.filter(s => s.id === currentStaff?.staffId)
     : staffMembers;
   ```
   Use `visibleStaff` in the render loop instead of `staffMembers`.
3. Hide the following for seamstresses:
   - Gantt chart section (wrap with `{!isSeamstress && (...)}`)
   - Overloaded days alert/panel (if present, wrap with `{!isSeamstress && (...)}`)
   - Per-staff export buttons (wrap with `{!isSeamstress && (...)}`)
   - Any "all staff" summary statistics
4. Keep visible for seamstresses:
   - Their own utilization gauge card
   - Unassigned tasks pool (if shown on workload page)
   - The OrderDetailModal inline rendering (seamstresses can click an order to see details)

**Redirect guards (4 pages):**

For each of these pages, add a redirect guard at the TOP of the component:
- `src/app/intake/page.tsx`
- `src/app/clients/page.tsx`
- `src/app/archived/page.tsx`
- `src/app/dashboard/page.tsx`

Pattern for each page:
1. Import `useStaffSession` from `@/components/staff` (if not already imported)
2. Import `useRouter` from `next/navigation` (if not already imported)
3. At the top of the component body:
   ```typescript
   const { currentStaff, isLoading } = useStaffSession();
   const router = useRouter();

   useEffect(() => {
     if (!isLoading && currentStaff?.staffRole === 'seamstress') {
       router.replace('/board');
     }
   }, [isLoading, currentStaff, router]);
   ```
4. Add an early return during the redirect: `if (currentStaff?.staffRole === 'seamstress') return null;`

This prevents any flash of restricted content. The `useEffect` redirect handles the navigation; the early return prevents rendering restricted UI during the redirect.

Note: If any of these pages already import `useStaffSession` or `useRouter`, reuse the existing imports. If they already destructure `currentStaff`, reuse it. Do NOT duplicate hook calls.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Read workload page to confirm:
   - `isSeamstress` check added
   - Staff gauges filtered to only current seamstress
   - Gantt and export sections hidden for seamstresses
3. Read each redirect guard page to confirm:
   - `useEffect` with redirect to `/board` for seamstresses
   - Early return `null` to prevent flash of content
  </verify>
  <done>
- Workload page shows only seamstress's own gauge (hides other staff, Gantt, exports)
- Intake page redirects seamstresses to /board
- Clients page redirects seamstresses to /board
- Archived page redirects seamstresses to /board
- Dashboard page redirects seamstresses to /board
- No flash of restricted content during redirect
- Manager/admin experience completely unchanged on all pages
- TypeScript compiles clean
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles clean: `npx tsc --noEmit`
2. Calendar: seamstress task filtering uses `currentStaff.staffId`
3. Workload: only own gauge visible for seamstresses
4. All 4 restricted pages have redirect guards
5. No manager/admin behavior changes
</verification>

<success_criteria>
- Seamstress calendar shows only their tasks + unassigned pool
- Seamstress workload shows only their own gauge
- Seamstresses are redirected away from intake, clients, archived, dashboard
- Manager/admin experience completely unchanged
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/27-role-based-access-control-seamstress-view-filtering/27-03-SUMMARY.md`
</output>
