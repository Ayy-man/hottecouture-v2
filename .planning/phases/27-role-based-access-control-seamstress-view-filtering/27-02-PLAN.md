---
phase: 27-role-based-access-control-seamstress-view-filtering
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/board/order-detail-modal.tsx
autonomous: true
requirements:
  - RBAC-03

must_haves:
  truths:
    - "Seamstress sees ALL garments and tasks in the order detail modal (full job context)"
    - "Seamstress does NOT see the pricing section (subtotal, tax, total, deposit, balance)"
    - "Seamstress does NOT see the payment section (PaymentStatusSection)"
    - "Seamstress does NOT see client phone, email, reveal button, or history link"
    - "Seamstress does NOT see Edit Price buttons on individual services"
    - "Seamstress does NOT see the archive/unarchive button"
    - "Seamstress CAN see Print Labels and Manage Tasks buttons"
    - "Manager/admin sees full modal with all sections"
  artifacts:
    - path: "src/components/board/order-detail-modal.tsx"
      provides: "Role-aware order detail modal"
      contains: "isSeamstress"
  key_links:
    - from: "src/components/board/order-detail-modal.tsx"
      to: "useStaffSession()"
      via: "direct hook call inside modal"
      pattern: "useStaffSession"
---

<objective>
Add role-based content hiding to the OrderDetailModal so seamstresses see garments/tasks but not pricing, payments, or client contact info.

Purpose: Seamstresses need job context (what to sew, for which order) but should not see financial details or client personal information. This maintains information boundaries while keeping seamstresses informed about their work.
Output: OrderDetailModal with conditional sections based on staff role.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/27-role-based-access-control-seamstress-view-filtering/27-RESEARCH.md
@src/components/board/order-detail-modal.tsx
@src/components/staff/staff-session-provider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add role-based section hiding to OrderDetailModal</name>
  <files>src/components/board/order-detail-modal.tsx</files>
  <action>
**Setup (top of component body):**
1. Import `useStaffSession` from `@/components/staff`
2. Inside the `OrderDetailModal` component function, add: `const { currentStaff, isLoading: isStaffLoading } = useStaffSession();`
3. Derive: `const isSeamstress = currentStaff?.staffRole === 'seamstress';`

This approach (calling `useStaffSession()` directly inside the modal) is preferred over threading a prop, per the research recommendation. `StaffSessionProvider` wraps the entire app so this works from any call site.

**CRITICAL: Handle the loading state.** During the brief hydration window before `currentStaff` resolves, `isSeamstress` is `false`, which would momentarily show pricing/payment sections to seamstresses. To prevent this flash:
- If `isStaffLoading` is true, render the modal body as a simple loading skeleton or spinner instead of the full content. A minimal approach: wrap the modal body content in `{isStaffLoading ? <div className="flex justify-center p-8"><LoadingLogo /></div> : (/* existing modal body */)}`. Import `LoadingLogo` from `@/components/ui/loading-logo` (already used elsewhere in the app).
- This is a lightweight guard — the staff session resolves from localStorage almost instantly, so users will rarely see the skeleton. But it prevents the security-sensitive flash of financial data.

**Hide pricing section for seamstresses:**
Find the pricing `<div>` (contains subtotal, rush fee, tax, total, deposit, balance — approximately lines 1074-1184 in current file). Wrap the ENTIRE pricing div with `{!isSeamstress && (...)}`.

**Hide payment section for seamstresses:**
Find the `<PaymentStatusSection>` wrapper div (approximately lines 1186-1204). Wrap with `{!isSeamstress && (...)}`.

**Hide client contact info for seamstresses:**
Find the "Client Information" card section (approximately lines 624-677). Within it:
- KEEP: client name display and language preference (seamstresses need to know whose order it is)
- HIDE: client phone number, client email, the "reveal" toggle button, and the "Voir l'historique" (view history) link
- Wrap each hidden element individually with `{!isSeamstress && (...)}` to preserve layout

**Hide service-level "Edit Price" buttons for seamstresses:**
Find each `<Button>` that calls `handleStartEditServicePrice(...)` (in the garment/service rows). Wrap each with `{!isSeamstress && (...)}`.

**Hide per-service price display for seamstresses:**
Find the price info blocks on each service row (showing "Est: $X", final price, FINAL badge). Wrap the entire price display column/div with `{!isSeamstress && (...)}`.

**Hide archive button for seamstresses:**
Find the `<HoldToArchiveButton>` or archive/unarchive button in the actions bar at the bottom. Wrap with `{!isSeamstress && (...)}`.

**KEEP visible for seamstresses:**
- "Print Labels" button — seamstresses need to print labels for their work
- "Manage Tasks" button — seamstresses need to manage task status
- All garment items and service names — seamstresses need full job context
- Order number, status, due date — operational info
- Client name — needed to identify the order
- Notes section — operational context

Do NOT hide entire garment sections. The design decision explicitly says: "seamstresses see ALL garments/tasks (full job context)".
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Read the modified file to confirm:
   - `useStaffSession` is imported and called, destructuring both `currentStaff` and `isLoading`
   - `isSeamstress` is derived from `currentStaff.staffRole`
   - Modal body shows loading skeleton when `isStaffLoading` is true (prevents flash of pricing data)
   - Pricing section wrapped in `{!isSeamstress && (...)}`
   - Payment section wrapped in `{!isSeamstress && (...)}`
   - Client phone/email/reveal/history hidden for seamstresses
   - Service price edit buttons hidden for seamstresses
   - Per-service price display hidden for seamstresses
   - Archive button hidden for seamstresses
   - Garments, tasks, Print Labels, Manage Tasks are NOT hidden
  </verify>
  <done>
- Seamstress sees all garments/tasks in modal (full job context)
- Pricing section (subtotal, tax, total, deposit, balance) hidden for seamstress
- Payment section (PaymentStatusSection) hidden for seamstress
- Client phone, email, reveal button, history link hidden for seamstress
- Service Edit Price buttons and price displays hidden for seamstress
- Archive button hidden for seamstress
- Print Labels and Manage Tasks remain visible for seamstress
- Modal body shows loading skeleton during staff session hydration (prevents flash of financial data for seamstresses)
- Manager/admin modal is completely unchanged
- TypeScript compiles clean
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles clean: `npx tsc --noEmit`
2. All hiding uses `{!isSeamstress && (...)}` conditional rendering (not CSS)
3. `useStaffSession()` called directly inside modal (no prop threading)
4. No garment/task sections are hidden (full job context preserved)
5. Print Labels and Manage Tasks buttons remain accessible
</verification>

<success_criteria>
- OrderDetailModal hides pricing, payments, client contact, price edit buttons, and archive button for seamstresses
- OrderDetailModal shows ALL garments, tasks, labels, and task management for seamstresses
- Manager/admin modal experience completely unchanged
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/27-role-based-access-control-seamstress-view-filtering/27-02-SUMMARY.md`
</output>
