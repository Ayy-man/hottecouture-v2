---
phase: 17-contact-field-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/0038_update_preferred_contact_and_fields.sql
  - src/lib/dto.ts
  - src/components/intake/client-step.tsx
  - src/app/api/intake/route.ts
autonomous: true

must_haves:
  truths:
    - "Cannot create a new client without providing a mobile/SMS number"
    - "Cannot create a new client without providing an email address"
    - "Landline phone field is optional when creating a client"
    - "Preferred contact dropdown includes Phone (Landline) option alongside Email and SMS"
    - "Selecting Phone (Landline) as preferred contact saves 'phone' value to database"
    - "Existing clients with missing mobile_phone or email are still viewable and selectable in search"
  artifacts:
    - path: "supabase/migrations/0038_update_preferred_contact_and_fields.sql"
      provides: "Database CHECK constraint update to allow 'phone' in preferred_contact"
      contains: "preferred_contact IN"
    - path: "src/lib/dto.ts"
      provides: "Updated Zod schemas with mobile_phone required and phone optional"
      contains: "mobile_phone: phoneSchema"
    - path: "src/components/intake/client-step.tsx"
      provides: "Updated form with mobile_phone required, phone optional, phone in preferred_contact"
      contains: "Mobile/SMS"
  key_links:
    - from: "src/components/intake/client-step.tsx"
      to: "src/lib/dto.ts"
      via: "ClientCreate type shapes form state and validation"
      pattern: "ClientCreate"
    - from: "src/components/intake/client-step.tsx"
      to: "supabase client.insert"
      via: "createClientInDB inserts mobile_phone to database"
      pattern: "mobile_phone"
    - from: "src/lib/dto.ts"
      to: "src/app/api/intake/route.ts"
      via: "intakeRequestSchema validates incoming client data"
      pattern: "clientCreateSchema"
---

<objective>
Make mobile_phone (SMS) and email both mandatory fields for new client creation. Change phone (landline) from required to optional. Add "Phone (Landline)" as a third option in the preferred contact dropdown. Ensure existing clients with incomplete data remain viewable.

Purpose: Client (Audrey) wants SMS and email both mandatory for all new clients so N8N notifications always work. Landline phone should be an optional contact preference.
Output: Updated validation schemas, form UI, database constraint, and API to enforce new rules.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/dto.ts
@src/components/intake/client-step.tsx
@src/app/api/intake/route.ts
@supabase/migrations/0004_add_client_communication_fields.sql
@supabase/migrations/0035_add_mobile_phone_to_client.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and Zod schema updates</name>
  <files>
    supabase/migrations/0038_update_preferred_contact_and_fields.sql
    src/lib/dto.ts
  </files>
  <action>
    1. Create migration `supabase/migrations/0038_update_preferred_contact_and_fields.sql`:
       - DROP the existing CHECK constraint on `client.preferred_contact` (constraint name from 0004 migration â€” use: `ALTER TABLE client DROP CONSTRAINT IF EXISTS client_preferred_contact_check;`)
       - ADD new CHECK constraint: `ALTER TABLE client ADD CONSTRAINT client_preferred_contact_check CHECK (preferred_contact IN ('email', 'sms', 'phone'));`
       - Do NOT add NOT NULL constraints to mobile_phone or email columns â€” existing clients may have NULLs
       - Add comment: `COMMENT ON COLUMN client.preferred_contact IS 'Preferred contact method: email, sms, or phone (landline)';`

    2. Update `src/lib/dto.ts` â€” clientCreateSchema:
       - Change `phone: phoneSchema` to `phone: phoneSchema.optional()` (landline is now optional)
       - Change `mobile_phone: phoneSchema.optional()` to `mobile_phone: phoneSchema` (SMS is now required, remove .optional())
       - `email: emailSchema` stays as-is (already required)
       - Change `preferred_contact: z.enum(['email', 'sms']).default('sms')` to `z.enum(['email', 'sms', 'phone']).default('sms')`

    3. Update `src/lib/dto.ts` â€” clientUpdateSchema:
       - clientUpdateSchema is `clientCreateSchema.partial()` which already makes all fields optional â€” no changes needed. This ensures existing clients can be updated without providing all required fields.

    Do NOT modify any other schemas. The intakeRequestSchema uses clientCreateSchema by reference so it picks up changes automatically.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm TypeScript compiles clean. Check that clientCreateSchema.parse({ first_name: 'Test', last_name: 'User', mobile_phone: '+15551234567', email: 'test@test.com', language: 'fr', preferred_contact: 'phone' }) would be valid (mobile_phone required, phone optional, preferred_contact accepts 'phone').
  </verify>
  <done>
    - clientCreateSchema requires mobile_phone (not optional) and email (already required)
    - clientCreateSchema makes phone optional
    - preferred_contact enum accepts 'email', 'sms', 'phone'
    - Migration file exists with CHECK constraint update
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update client form UI and intake API</name>
  <files>
    src/components/intake/client-step.tsx
    src/app/api/intake/route.ts
  </files>
  <action>
    1. Update `src/components/intake/client-step.tsx` â€” form field layout:

       a. **Reorder and relabel fields** in the create form:
          - Row 1: First name *, Last name * (unchanged)
          - Row 2: Mobile/SMS * (required), Email * (required) â€” swap mobile to be prominent
          - Row 3: Phone (Landline) â€” optional, no asterisk. Move current "phone" field here with label "TÃ©lÃ©phone fixe (optionnel)"
          - The current "TÃ©lÃ©phone *" field (which maps to `phone`) becomes optional "TÃ©lÃ©phone fixe (optionnel)"
          - The current "Mobile/SMS (optionnel)" field (which maps to `mobile_phone`) becomes required "Mobile/SMS *"

       b. **Update formData initial state**: Set `mobile_phone: ''` (required, starts empty like other required fields). Set `phone: ''` (optional).

       c. **Add mobile_phone validation** â€” create a `validateMobilePhone` function similar to `validatePhone`:
          - Required: "Le numÃ©ro mobile/SMS est requis"
          - Format: Same regex as phone â€” `/^\+?[\d\s\-\(\)]+$/`
          - Add `handleMobilePhoneChange` function with real-time validation (same pattern as handlePhoneChange)
          - Wire into the mobile_phone input's onChange

       d. **Update handleCreateClient validation**:
          - Add mobile_phone validation: `const mobileError = validateMobilePhone(formData.mobile_phone || ''); if (mobileError) newErrors.mobile_phone = mobileError;`
          - Make phone validation optional: Only validate phone format IF a value is provided (remove the "required" check from validatePhone, keep format check)
          - Keep email validation as-is (already required)

       e. **Update preferred_contact dropdown**:
          - Add third option: `<option value='phone'>ðŸ“ž TÃ©lÃ©phone</option>`
          - Update type cast to include 'phone': `as 'email' | 'sms' | 'phone'`

       f. **Update createClientInDB insert**:
          - Add `mobile_phone: (formData.mobile_phone || '').trim() || null` to the insert object
          - Change phone line to: `phone: (formData.phone || '').trim() || null` (allow null since optional)
          - Add `preferred_contact: formData.preferred_contact` to the insert object (currently NOT being saved to DB!)

       g. **Update search query** in `searchClients`:
          - Add `mobile_phone` to the select fields: include `mobile_phone` in the select string
          - Optionally search by mobile_phone too in the `.or()` filter

       h. **Update formData reset** after client creation â€” include `mobile_phone: ''`

    2. Update `src/app/api/intake/route.ts` â€” client insert:
       - In the "Create new client" insert block (~line 101), add `mobile_phone: client.mobile_phone || null` to the insert object
       - Add `preferred_contact: client.preferred_contact || 'sms'` to the insert object
       - This ensures clients created through the intake flow also save mobile_phone and preferred_contact

    Important: Do NOT block existing client search/selection when clients lack mobile_phone or email. The validation only applies to the CREATE form, not to selecting existing clients from search.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm TypeScript compiles clean. Visually verify by reading the updated files that:
    1. Mobile/SMS field has required indicator (*)
    2. Phone (landline) field has NO required indicator
    3. Preferred contact dropdown has three options (Email, SMS, Phone)
    4. createClientInDB passes mobile_phone to insert
    5. Intake API passes mobile_phone and preferred_contact to client insert
    6. Form validation requires mobile_phone and email, makes phone optional
  </verify>
  <done>
    - Mobile/SMS field is required with asterisk and real-time validation
    - Phone (landline) field is optional with "optionnel" label
    - Email field remains required with asterisk
    - Preferred contact dropdown shows Email, SMS, and Phone (Landline) options
    - Client creation saves mobile_phone and preferred_contact to database
    - Intake API passes mobile_phone and preferred_contact when creating clients
    - Existing clients without mobile_phone can still be selected from search
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. Migration file 0038 exists with correct CHECK constraint update
3. clientCreateSchema in dto.ts: mobile_phone is required, phone is optional, preferred_contact accepts 'phone'
4. Client form: Mobile/SMS has asterisk (*), Phone (landline) says "optionnel", preferred contact has 3 options
5. createClientInDB includes mobile_phone and preferred_contact in insert
6. Intake API includes mobile_phone and preferred_contact in client insert
7. Existing client search/selection is NOT blocked by missing fields
</verification>

<success_criteria>
- New client creation requires mobile_phone (SMS) and email â€” form won't submit without both
- Phone (landline) is optional for new clients
- "Phone (Landline)" appears as third preferred contact option
- Selecting preferred contact 'phone' persists to database after migration runs
- Existing clients with incomplete data remain searchable and selectable
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/17-contact-field-validation/17-01-SUMMARY.md`
</output>
