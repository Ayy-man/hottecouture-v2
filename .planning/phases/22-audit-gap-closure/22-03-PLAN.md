---
phase: 22-audit-gap-closure
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/intake/garment-services-step.tsx
autonomous: true

must_haves:
  truths:
    - "Add garment type button visible in merged intake step below garment type dropdown"
    - "Clicking button shows inline form with name input, category selector, and Create/Cancel buttons"
    - "Creating a custom type calls /api/admin/garment-types API and refreshes the type list"
    - "Newly created type auto-selects in the garment type dropdown"
    - "Maximum 10 custom types enforced with visual feedback"
  artifacts:
    - path: "src/components/intake/garment-services-step.tsx"
      provides: "Add Custom Type section in garment type dropdown area"
      contains: "handleCreateCustomType"
  key_links:
    - from: "src/components/intake/garment-services-step.tsx"
      to: "/api/admin/garment-types"
      via: "fetch POST to create custom garment type"
      pattern: "fetch.*garment-types.*POST"
---

<objective>
Port the "Add Custom Type" section from old garments-step.tsx into the merged garment-services-step.tsx.

Purpose: Client wants to build their garment type database during intake (AUTOMATO NEW-009, client quote: "Ca va nous permettre de construire notre banque"). The old garments-step.tsx has this feature (lines 698-776) but it was not carried over during the Phase 3 merge. The STATE.md decision "Read-only garment types in merged step" is being REVISED per client request.

Output: "Add Custom Type..." button appears in the garment type dropdown, opening an inline form to create new garment types on the fly.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/intake/garment-services-step.tsx
@src/components/intake/garments-step.tsx (lines 70-72, 210-249, 396-404, 698-776 for source code)
@src/app/api/admin/garment-types/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add state variables and handler for custom garment type creation</name>
  <files>src/components/intake/garment-services-step.tsx</files>
  <action>
  Port the custom type creation logic from garments-step.tsx into garment-services-step.tsx.

  **1. Add state variables** after the existing garment dropdown state (after line ~108, near `const [isDropdownOpen, setIsDropdownOpen] = useState(false);`):

  ```tsx
  // Custom garment type state (ported from garments-step.tsx)
  const [showAddCustomForm, setShowAddCustomForm] = useState(false);
  const [customTypeName, setCustomTypeName] = useState('');
  const [customTypeCategory, setCustomTypeCategory] = useState('other');
  ```

  **2. Add customTypesCount computed value** after the staff hook (~line 125, after `const toast = useToast();`):

  ```tsx
  // Get custom types count (max 10 allowed)
  const customTypesCount = garmentTypes.filter(
    t => t.is_custom && t.is_active !== false
  ).length;
  ```

  **3. Add handleCreateCustomType function** after the existing handleGarmentTypeChange function (find it by searching for `handleGarmentTypeChange`). Port from garments-step.tsx lines 212-249:

  ```tsx
  const handleCreateCustomType = async () => {
    if (!customTypeName.trim()) return;

    try {
      const response = await fetch('/api/admin/garment-types', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: customTypeName.trim(),
          category: customTypeCategory,
          icon: 'üìù',
        }),
      });

      const result = await response.json();

      if (!response.ok) {
        alert(result.error || 'Failed to create custom garment type');
        return;
      }

      // Reload garment types
      await loadGarmentTypes();

      // Select the newly created type
      if (result.garmentType) {
        handleGarmentTypeChange(result.garmentType.id);
      }

      // Reset form
      setCustomTypeName('');
      setCustomTypeCategory('other');
      setShowAddCustomForm(false);
    } catch (error) {
      console.error('Error creating custom type:', error);
      alert('Failed to create custom garment type');
    }
  };
  ```

  **4. Add the custom type form UI** inside the garment type dropdown, AFTER the mapped category groups but still inside the dropdown `<div>`. Find the closing of the `Object.entries(groupedTypes).map(...)` block (around line 636) and add this BEFORE the closing `</div>` of the dropdown container (line ~637):

  ```tsx
  {/* Add Custom Type Section */}
  <div className='border-t border-border'>
    {showAddCustomForm ? (
      <div className='p-3 space-y-2 bg-muted/50'>
        <input
          type='text'
          value={customTypeName}
          onChange={e => setCustomTypeName(e.target.value)}
          placeholder='Nom du type personnalise...'
          className='w-full px-3 py-2 border border-border rounded text-sm min-h-[44px]'
          autoFocus
          onKeyDown={e => {
            if (e.key === 'Enter') handleCreateCustomType();
            if (e.key === 'Escape') {
              setShowAddCustomForm(false);
              setCustomTypeName('');
            }
          }}
        />
        <select
          value={customTypeCategory}
          onChange={e => setCustomTypeCategory(e.target.value)}
          className='w-full px-3 py-2 border border-border rounded text-sm min-h-[44px]'
        >
          <option value='other'>Autre</option>
          <option value='home'>Maison</option>
          <option value='outdoor'>Exterieur</option>
          <option value='womens'>Femmes</option>
          <option value='mens'>Hommes</option>
          <option value='outerwear'>Manteaux</option>
          <option value='formal'>Formel</option>
          <option value='activewear'>Sport</option>
        </select>
        <div className='flex gap-2'>
          <button
            onClick={() => {
              setShowAddCustomForm(false);
              setCustomTypeName('');
            }}
            className='flex-1 px-3 py-2 bg-muted text-muted-foreground rounded text-sm min-h-[44px] touch-manipulation'
          >
            Annuler
          </button>
          <button
            onClick={handleCreateCustomType}
            disabled={!customTypeName.trim() || customTypesCount >= 10}
            className='flex-1 px-3 py-2 bg-primary-500 text-white rounded text-sm min-h-[44px] touch-manipulation disabled:opacity-50'
          >
            Creer
          </button>
        </div>
        {customTypesCount >= 10 && (
          <p className='text-xs text-red-600'>
            Maximum 10 types personnalises atteint
          </p>
        )}
      </div>
    ) : (
      <button
        type='button'
        onClick={() => setShowAddCustomForm(true)}
        disabled={customTypesCount >= 10}
        className='w-full px-3 py-3 text-left text-sm text-primary-600 hover:bg-muted/50 flex items-center gap-2 min-h-[44px] touch-manipulation disabled:opacity-50 disabled:cursor-not-allowed'
      >
        <span>+</span>
        <span>Ajouter un type personnalise...</span>
        {customTypesCount >= 10 && (
          <span className='ml-auto text-xs text-red-600'>
            (Limite atteinte)
          </span>
        )}
      </button>
    )}
  </div>
  ```

  **Important notes:**
  - Use French labels throughout (matching codebase convention from Phase 19 decision)
  - Keep 44px min-height touch targets (Phase 21 requirement)
  - Keep touch-manipulation class for mobile
  - The `loadGarmentTypes` function already exists in the merged step (line 146)
  - The `handleGarmentTypeChange` function already exists
  - The `/api/admin/garment-types` POST endpoint already exists and returns `{ garmentType: {...} }`
  - Do NOT modify the is_custom field in GarmentType interface ‚Äî it's already there (line 33)
  </action>
  <verify>Run `npx tsc --noEmit` to verify TypeScript compiles clean. Grep for "handleCreateCustomType" in garment-services-step.tsx to confirm the handler exists. Grep for "Ajouter un type" to confirm the button text.</verify>
  <done>Garment-services-step.tsx has "Add Custom Type" section with inline form inside dropdown. Creates types via API, refreshes list, auto-selects new type. 10-type limit enforced. All labels in French. TypeScript compiles clean.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `grep -n "handleCreateCustomType" src/components/intake/garment-services-step.tsx` shows the handler function
3. `grep -n "showAddCustomForm" src/components/intake/garment-services-step.tsx` shows state variable
4. `grep -n "customTypesCount" src/components/intake/garment-services-step.tsx` shows the computed count
5. `grep -n "Ajouter un type" src/components/intake/garment-services-step.tsx` shows the French button label
6. `grep -n "api/admin/garment-types" src/components/intake/garment-services-step.tsx` shows the API call
</verification>

<success_criteria>
- "Ajouter un type personnalise..." button visible in garment type dropdown
- Clicking opens inline form with name input and category selector
- Enter key submits, Escape key cancels
- Custom type created via /api/admin/garment-types POST
- Type list refreshes and new type auto-selects after creation
- 10-type limit enforced with "Limite atteinte" message
- All labels in French
- 44px touch targets maintained
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/22-audit-gap-closure/22-03-SUMMARY.md`
</output>
