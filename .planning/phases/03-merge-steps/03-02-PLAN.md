---
phase: 03-merge-steps
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/intake/garment-services-step.tsx
  - src/app/intake/page.tsx
autonomous: false

must_haves:
  truths:
    - "Order intake has one less page navigation"
    - "Garment and service selection visible simultaneously"
    - "Add to Order button finalizes item with all details"
    - "Previously added items shown in sidebar"
    - "Can proceed to pricing step after adding items"
  artifacts:
    - path: "src/app/intake/page.tsx"
      provides: "Updated wizard with merged step"
      contains: "GarmentServicesStep"
    - path: "src/components/intake/garment-services-step.tsx"
      provides: "Complete merged component with Add to Order"
      exports: ["GarmentServicesStep"]
  key_links:
    - from: "src/app/intake/page.tsx"
      to: "GarmentServicesStep"
      via: "component import and render"
      pattern: "import.*GarmentServicesStep"
    - from: "GarmentServicesStep"
      to: "onUpdate callback"
      via: "Add to Order handler"
      pattern: "onUpdate.*garments"
---

<objective>
Complete the merged step by adding "Add to Order" functionality, order items sidebar, and wiring into the intake page wizard.

Purpose: Replace separate garments and services steps with merged GarmentServicesStep to reduce navigation by one step.

Output: Working intake flow with merged garment/services page that allows full item configuration before adding to order.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-merge-steps/03-RESEARCH.md
@.planning/phases/03-merge-steps/03-01-SUMMARY.md

# Files to modify
@src/app/intake/page.tsx
@src/components/intake/garment-services-step.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add "Add to Order" functionality and order items sidebar</name>
  <files>src/components/intake/garment-services-step.tsx</files>
  <action>
Complete the GarmentServicesStep component with commit-to-order functionality:

1. **Add to Order Handler**:
```typescript
const handleAddToOrder = () => {
  // Validation: must have garment type and at least one service
  if (!currentGarment.garment_type_id || !currentGarment.services?.length) {
    return;
  }

  // Commit current garment to the data array
  const newGarment: Garment = {
    type: currentGarment.type || '',
    garment_type_id: currentGarment.garment_type_id,
    notes: currentGarment.notes || '',
    labelCode: currentGarment.labelCode || nanoid(8).toUpperCase(),
    photo_path: currentGarment.photo_path || null,
    services: currentGarment.services || [],
  };

  onUpdate([...data, newGarment]);

  // Reset for next garment
  setCurrentGarment({
    type: '',
    garment_type_id: null,
    notes: '',
    labelCode: nanoid(8).toUpperCase(),
    photo_path: null,
    services: [],
  });
  setPhotoPreview(null);
};
```

2. **Add to Order Button** (at bottom of selected services section):
```tsx
<Button
  onClick={handleAddToOrder}
  disabled={!currentGarment.garment_type_id || !currentGarment.services?.length}
  className="w-full bg-gradient-to-r from-primary-500 to-accent-clay hover:from-primary-600 hover:to-accent-clay text-white"
>
  Ajouter a la commande
</Button>
```

3. **Order Items Sidebar** (shows previously added garments):
```tsx
{/* Order Items Panel - Right side or collapsible on mobile */}
<div className="bg-white rounded-lg border p-4">
  <h3 className="font-medium mb-3">Articles ({data.length})</h3>

  {data.length === 0 ? (
    <p className="text-sm text-muted-foreground">Aucun article ajoute</p>
  ) : (
    <div className="space-y-2">
      {data.map((garment, idx) => (
        <div key={garment.labelCode} className="flex items-center justify-between p-2 bg-muted rounded">
          <div className="min-w-0 flex-1">
            <p className="font-medium truncate">{garment.type}</p>
            <p className="text-xs text-muted-foreground">
              {garment.services.length} service(s)
            </p>
          </div>
          <Button
            variant="ghost"
            size="sm"
            onClick={() => removeGarment(idx)}
            className="text-destructive hover:text-destructive"
          >
            <X className="h-4 w-4" />
          </Button>
        </div>
      ))}
    </div>
  )}
</div>

// Handler:
const removeGarment = (index: number) => {
  const updated = data.filter((_, i) => i !== index);
  onUpdate(updated);
};
```

4. **Validation State Display**:
- Show warning if no garment type selected
- Show warning if no services selected
- Disable "Suivant" until at least one garment added to order

5. **Navigation Buttons**:
```tsx
<Button onClick={onPrev} variant="ghost">Retour</Button>
<Button
  onClick={onNext}
  disabled={data.length === 0}
  className="bg-gradient-to-r from-primary-500 to-accent-clay"
>
  Suivant
</Button>
```
  </action>
  <verify>Can add configured garment to order, see it in sidebar, remove it, proceed when items exist</verify>
  <done>Add to Order button commits garment+services to data array, sidebar shows added items with remove option, Suivant enabled when items > 0</done>
</task>

<task type="auto">
  <name>Task 2: Update intake page to use merged step</name>
  <files>src/app/intake/page.tsx</files>
  <action>
Modify the intake page wizard to use the new merged component:

1. **Update IntakeStep type** (line ~16):
```typescript
type IntakeStep =
  | 'pipeline'
  | 'client'
  | 'garment-services'  // NEW - replaces 'garments' and 'services'
  | 'pricing'
  | 'assignment'
  | 'summary';
```

2. **Update steps array** (line ~88):
```typescript
const steps: Array<{ key: IntakeStep; title: string; description: string }> =
  useMemo(
    () => [
      { key: 'client', title: 'Client', description: 'Client information and contact details' },
      { key: 'pipeline', title: 'Service Type', description: 'Choose alteration or custom design' },
      { key: 'garment-services', title: 'Articles', description: 'Add garments, services, and assign' },  // MERGED
      { key: 'pricing', title: 'Pricing & Due Date', description: 'Final pricing and due date' },
      { key: 'assignment', title: 'Assignment', description: 'Review assignments' },
    ],
    []
  );
```

3. **Add import** (at top with other imports):
```typescript
import { GarmentServicesStep } from '@/components/intake/garment-services-step';
```

4. **Update renderStep()** (line ~261):
```typescript
// REMOVE these two cases:
// case 'garments': ...
// case 'services': ...

// ADD this single case:
case 'garment-services':
  return (
    <GarmentServicesStep
      data={formData.garments}
      onUpdate={garments => updateFormData({ garments })}
      onNext={nextStep}
      onPrev={prevStep}
      orderType={formData.order.type}
      client={formData.client}
      onChangeCustomer={() => setCurrentStep('client')}
    />
  );
```

5. **Remove old imports** (if GarmentsStep and ServicesStepNew are no longer needed):
```typescript
// REMOVE:
// import { GarmentsStep } from '@/components/intake/garments-step';
// import { ServicesStepNew } from '@/components/intake/services-step-new';
```

Note: Keep old component files (garments-step.tsx, services-step-new.tsx) for now in case rollback needed. They can be deleted in a cleanup phase.
  </action>
  <verify>Intake page loads without errors, step progression works: client -> pipeline -> garment-services -> pricing -> assignment</verify>
  <done>Intake wizard uses merged GarmentServicesStep, old separate steps removed from flow, navigation sequence correct</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Merged garment and service selection page with inline seamstress assignment</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Navigate to http://localhost:3000/intake
3. Complete Client step (any test data)
4. Select Pipeline (Alteration)
5. **On merged page, verify:**
   - Garment type dropdown shows categories (Women, Men, etc.)
   - Can select a garment type
   - Category tabs appear for services
   - Can click services to add them
   - Selected services show with quantity controls
   - Each service has seamstress assignment dropdown with staff names
   - "Ajouter a la commande" button adds item to sidebar
   - Can add multiple garments
   - "Suivant" is disabled until at least one garment added
   - "Suivant" proceeds to Pricing step
6. Complete order to verify no regression
  </how-to-verify>
  <resume-signal>Type "approved" if flow works correctly, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks:
1. Intake page compiles: `npx tsc --noEmit`
2. Dev server starts: `npm run dev` (no console errors)
3. Step sequence is now 5 steps (was 6): client -> pipeline -> garment-services -> pricing -> assignment
4. Merged step shows both garment dropdown and service categories
5. Seamstress dropdown appears for each selected service
6. Can complete full order intake flow
</verification>

<success_criteria>
1. One less page navigation in order creation workflow (5 steps instead of 6)
2. Garment selection and service selection visible simultaneously
3. Seamstress assignment dropdown appears on same page for each service
4. "Add to Order" button finalizes item with garment + services + assignments
5. No loss of existing search/filter functionality for services
6. All existing order intake functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/03-merge-steps/03-02-SUMMARY.md`
</output>
