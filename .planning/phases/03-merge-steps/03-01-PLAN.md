---
phase: 03-merge-steps
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/intake/garment-services-step.tsx
autonomous: true

must_haves:
  truths:
    - "User can select garment type from dropdown on merged page"
    - "User can add notes and photo to garment on merged page"
    - "User can select services from category grid on merged page"
    - "User can assign seamstress per service via dropdown"
    - "User can add configured garment to order via button"
  artifacts:
    - path: "src/components/intake/garment-services-step.tsx"
      provides: "Merged garment and service selection component"
      min_lines: 500
      exports: ["GarmentServicesStep"]
  key_links:
    - from: "src/components/intake/garment-services-step.tsx"
      to: "/api/garment-types"
      via: "fetch in useEffect"
      pattern: "fetch.*api/garment-types"
    - from: "src/components/intake/garment-services-step.tsx"
      to: "useStaff"
      via: "hook import"
      pattern: "useStaff"
---

<objective>
Create merged GarmentServicesStep component that combines garment type selection, service selection, and inline seamstress assignment into a single page.

Purpose: Eliminate one page navigation in order intake workflow by allowing users to configure garment + services + assignment in one place before adding to order.

Output: New `garment-services-step.tsx` component ready to replace separate garments and services steps.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-merge-steps/03-RESEARCH.md

# Source components to port from
@src/components/intake/garments-step.tsx
@src/components/intake/services-step-new.tsx
@src/components/intake/assignment-step.tsx

# Hook for staff dropdown
@src/lib/hooks/useStaff.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GarmentServicesStep component shell</name>
  <files>src/components/intake/garment-services-step.tsx</files>
  <action>
Create new component `GarmentServicesStep` with this structure:

1. **Props interface** (same as ServicesStepNew):
```typescript
interface GarmentServicesStepProps {
  data: Garment[];  // All garments in order
  onUpdate: (garments: Garment[]) => void;
  onNext: () => void;
  onPrev: () => void;
  orderType: 'alteration' | 'custom';
  client?: any;
  onChangeCustomer?: () => void;
}
```

2. **State** - combine from both components:
- `currentGarment` state for garment being configured (from garments-step.tsx pattern)
- `garmentTypes`, `groupedTypes` for garment dropdown (from garments-step.tsx)
- `services`, `categories`, `activeTab` for service selection (from services-step-new.tsx)
- Import and use `useStaff()` hook for seamstress dropdown

3. **Layout structure** (responsive):
```
+--------------------------------------------------+
| Header: "Ajouter un article" | [Retour] [Suivant]|
+--------------------------------------------------+
| [Left Section - Garment Config]                  |
|   - Garment type dropdown (with category groups) |
|   - Photo capture (optional)                     |
|   - Notes field (optional)                       |
+--------------------------------------------------+
| [Main Section - Service Selection]               |
|   - Category tabs (grid)                         |
|   - Search bar                                   |
|   - Service list for selected category           |
+--------------------------------------------------+
| [Bottom Section - Selected Services]             |
|   - List of selected services with:              |
|     [Service Name] [Qty] [Price] [Assignee â–¾]    |
|   - "Add to Order" button (disabled until valid) |
+--------------------------------------------------+
| [Right Panel - Order Items]                      |
|   - Previously added garments with remove option |
+--------------------------------------------------+
```

4. **Initial state values**:
```typescript
const [currentGarment, setCurrentGarment] = useState<Partial<Garment>>({
  type: '',
  garment_type_id: null,
  notes: '',
  labelCode: nanoid(8).toUpperCase(),
  photo_path: null,
  services: [],
});
```

Port the data fetching logic:
- `loadGarmentTypes()` from garments-step.tsx (fetch `/api/garment-types`)
- `fetchServices()` and `loadCategories()` from services-step-new.tsx

Include all imports: React hooks, Button, Card, Select components, nanoid, lucide icons, useStaff, createClient from supabase.
  </action>
  <verify>File exists and TypeScript compiles: `npx tsc --noEmit src/components/intake/garment-services-step.tsx`</verify>
  <done>Component shell created with correct props interface, state management, layout structure, and data fetching hooks</done>
</task>

<task type="auto">
  <name>Task 2: Implement garment configuration section</name>
  <files>src/components/intake/garment-services-step.tsx</files>
  <action>
Port the garment type selection UI from garments-step.tsx:

1. **Garment Type Dropdown** - port from garments-step.tsx lines 280-450:
   - Custom dropdown with category groupings
   - State: `isDropdownOpen`, search within dropdown
   - Show grouped types from `groupedTypes` object
   - Handle selection: set `currentGarment.type` and `currentGarment.garment_type_id`

2. **Photo Capture** - port from garments-step.tsx lines 149-210:
   - File input with camera icon button
   - Preview thumbnail when photo captured
   - Upload to Supabase storage
   - Store path in `currentGarment.photo_path`

3. **Notes Field**:
   - Simple textarea for notes
   - Update `currentGarment.notes`

4. **Styling** - use existing Tailwind classes:
   - Compact form layout (reduce spacing per UI-03/UI-04 coming in Phase 4)
   - Responsive: stack vertically on mobile

**Critical:** Keep the garment type dropdown custom implementation (not shadcn Select) because it has category groupings and inline CRUD functionality.

**Do NOT** port the CRUD operations for garment types (add custom type, edit, delete) - keep it read-only for this phase to reduce complexity. The admin can manage types elsewhere.
  </action>
  <verify>Garment type dropdown renders with categories, photo capture works, notes field saves to state</verify>
  <done>Garment configuration section fully functional: dropdown shows grouped garment types, photo capture uploads to storage, notes save to currentGarment state</done>
</task>

<task type="auto">
  <name>Task 3: Implement service selection with inline assignment</name>
  <files>src/components/intake/garment-services-step.tsx</files>
  <action>
Port service selection UI from services-step-new.tsx and add inline assignment:

1. **Category Tabs** - port from services-step-new.tsx:
   - Grid of category buttons
   - Filter by orderType (alteration vs custom)
   - `activeTab` state for selected category
   - Sort alphabetically

2. **Service List** - port core functionality:
   - Filter services by `activeTab` category
   - Search filter by `searchTerm`
   - Display as list/grid of selectable services
   - Click to add service to `currentGarment.services`

3. **Add Service Handler** - adapted from services-step-new.tsx:
```typescript
const addServiceToCurrentGarment = (service: Service) => {
  const existingIndex = currentGarment.services?.findIndex(
    s => s.serviceId === service.id
  );

  if (existingIndex !== undefined && existingIndex >= 0) {
    // Increment qty if already exists
    const updatedServices = [...(currentGarment.services || [])];
    updatedServices[existingIndex].qty += 1;
    setCurrentGarment({ ...currentGarment, services: updatedServices });
  } else {
    // Add new service
    setCurrentGarment({
      ...currentGarment,
      services: [
        ...(currentGarment.services || []),
        {
          serviceId: service.id,
          serviceName: service.name,  // REQUIRED for AssignmentStep display
          qty: 1,
          customPriceCents: service.base_price_cents,
          assignedSeamstressId: null,  // Can be set inline
        },
      ],
    });
  }
};
```

4. **Selected Services Display with Assignment Dropdown**:
```tsx
{currentGarment.services?.map((svc, idx) => (
  <div key={svc.serviceId} className="flex items-center gap-2 p-2 bg-muted rounded">
    <span className="flex-1 truncate">{svc.serviceName}</span>
    <div className="flex items-center gap-1">
      <Button size="sm" onClick={() => updateQty(idx, -1)}>-</Button>
      <span className="w-8 text-center">{svc.qty}</span>
      <Button size="sm" onClick={() => updateQty(idx, 1)}>+</Button>
    </div>
    <span className="w-20 text-right">{formatCurrency(svc.customPriceCents || 0)}</span>

    {/* Inline Assignment Dropdown */}
    <Select
      value={svc.assignedSeamstressId || ''}
      onValueChange={(val) => updateAssignment(idx, val || null)}
    >
      <SelectTrigger className="w-32">
        <SelectValue placeholder="Assigner" />
      </SelectTrigger>
      <SelectContent>
        <SelectItem value="">Non assigne</SelectItem>
        {staff.map(s => (
          <SelectItem key={s.id} value={s.id}>{s.name}</SelectItem>
        ))}
      </SelectContent>
    </Select>

    <Button variant="ghost" size="sm" onClick={() => removeService(idx)}>
      <X className="h-4 w-4" />
    </Button>
  </div>
))}
```

5. **Helper functions**:
```typescript
const updateQty = (serviceIndex: number, delta: number) => {
  const updatedServices = [...(currentGarment.services || [])];
  const svc = updatedServices[serviceIndex];
  if (svc) {
    svc.qty = Math.max(1, svc.qty + delta);
    setCurrentGarment({ ...currentGarment, services: updatedServices });
  }
};

const updateAssignment = (serviceIndex: number, seamstressId: string | null) => {
  const updatedServices = [...(currentGarment.services || [])];
  const svc = updatedServices[serviceIndex];
  if (svc) {
    svc.assignedSeamstressId = seamstressId;
    setCurrentGarment({ ...currentGarment, services: updatedServices });
  }
};

const removeService = (serviceIndex: number) => {
  const updatedServices = currentGarment.services?.filter((_, i) => i !== serviceIndex) || [];
  setCurrentGarment({ ...currentGarment, services: updatedServices });
};
```

**Critical:** Include `serviceName` when adding service - this is required for AssignmentStep to display service names correctly.

**Skip for now:** Zip selection modal logic, service CRUD, price inline editing - focus on core flow. These can be ported in a follow-up if needed.
  </action>
  <verify>Can select services, adjust quantity, assign seamstress via dropdown, remove services</verify>
  <done>Service selection works with category tabs, search filter, and each selected service has quantity controls and assignment dropdown</done>
</task>

</tasks>

<verification>
After all tasks:
1. Component file exists: `ls src/components/intake/garment-services-step.tsx`
2. TypeScript compiles: `npx tsc --noEmit`
3. Component exports correctly: `grep "export.*GarmentServicesStep" src/components/intake/garment-services-step.tsx`
4. Uses useStaff hook: `grep "useStaff" src/components/intake/garment-services-step.tsx`
5. Fetches garment types: `grep "api/garment-types" src/components/intake/garment-services-step.tsx`
</verification>

<success_criteria>
1. GarmentServicesStep component created and compiles without errors
2. Garment type dropdown shows grouped types from API
3. Service selection with category tabs functional
4. Each selected service has inline assignment dropdown populated with staff
5. Photo capture and notes fields present
6. "Add to Order" button present (wiring in next plan)
</success_criteria>

<output>
After completion, create `.planning/phases/03-merge-steps/03-01-SUMMARY.md`
</output>
