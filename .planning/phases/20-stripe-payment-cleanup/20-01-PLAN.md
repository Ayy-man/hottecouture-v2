---
phase: 20-stripe-payment-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/payments/create-checkout/route.ts
  - src/app/api/payments/create-link/route.ts
  - src/lib/integrations/stripe.ts
autonomous: false
user_setup:
  - service: GoHighLevel
    why: "Payment page branding (logo, phone, business name) is controlled by GHL Dashboard, not code"
    dashboard_config:
      - task: "Upload shop logo to Business Profile"
        location: "GHL Dashboard -> Settings -> Business Profile -> General Information -> Logo"
      - task: "Update phone to shop number (not personal cell)"
        location: "GHL Dashboard -> Settings -> Business Profile -> General Information -> Business Phone"
      - task: "Verify business name shows 'Hotte Couture'"
        location: "GHL Dashboard -> Settings -> Business Profile -> General Information -> Business Name"
      - task: "Customize invoice layout and branding"
        location: "GHL Dashboard -> Payments -> Invoices & Estimates -> Settings -> Title, Terms and Layout -> Customize Layout"
      - task: "Preview invoice to confirm branding"
        location: "GHL Dashboard -> Payments -> Invoices -> Create test invoice -> Preview"

must_haves:
  truths:
    - "Fallback URL usage is logged with a warning so API issues are detectable"
    - "Dead Stripe Checkout code is removed to eliminate confusion"
    - "Payment page shows shop logo (GHL Dashboard config)"
    - "Payment page shows shop phone number, not personal cell (GHL Dashboard config)"
    - "Invoice URLs sent to customers are clean (no ugly query parameters)"
  artifacts:
    - path: "src/app/api/payments/create-checkout/route.ts"
      provides: "Fallback URL logging for debugging"
      contains: "FALLBACK_URL_USED"
  key_links:
    - from: "src/app/api/payments/create-checkout/route.ts"
      to: "GHL Text2Pay API"
      via: "createText2PayInvoice()"
      pattern: "createText2PayInvoice"
---

<objective>
Add defensive logging to the payment checkout endpoint when fallback URLs are used (indicates GHL API issues), and remove dead Stripe Checkout code that is no longer part of the payment flow. The remaining 90% of this phase (logo, phone number, branding) requires GHL Dashboard configuration by the user.

Purpose: Make payment URL issues debuggable and clean up unused code that causes confusion about which payment system is active.
Output: Updated create-checkout route with fallback logging, removed dead create-link route and unused createPaymentLink function.
</objective>

<execution_context>
@/Users/aymanbaig/.claude/get-shit-done/workflows/execute-plan.md
@/Users/aymanbaig/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-stripe-payment-cleanup/20-RESEARCH.md

Key source files:
@src/app/api/payments/create-checkout/route.ts
@src/lib/ghl/invoices.ts
@src/lib/integrations/stripe.ts
@src/app/api/payments/create-link/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fallback URL logging and remove dead Stripe code</name>
  <files>
    src/app/api/payments/create-checkout/route.ts
    src/app/api/payments/create-link/route.ts
    src/lib/integrations/stripe.ts
  </files>
  <action>
In `src/app/api/payments/create-checkout/route.ts` (lines 319-330), enhance the fallback URL block with structured warning logs:

1. When the primary `invoiceUrl` is missing from the GHL response and a fallback is constructed, add a `console.warn` with tag `[FALLBACK_URL_USED]` that includes:
   - The invoice ID (`invoice._id`)
   - Which fallback was used (custom domain vs GHL dashboard)
   - The constructed URL
   - A note that this indicates GHL Text2Pay did not return an invoiceUrl

2. In the "last resort" branch (GHL dashboard URL fallback), upgrade from `console.log` to `console.error` with tag `[FALLBACK_URL_CRITICAL]` since this URL is NOT a valid payment link and will not work for customers.

Specifically, replace lines 319-330:
```typescript
// Fallback URL construction if needed
if (!invoiceUrl) {
  if (invoice._id && invoice._id !== 'unknown') {
    // Use customer's GHL domain pattern
    invoiceUrl = `https://api.automatosolution.com/invoice/${invoice._id}`;
  } else {
    // Last resort: link to GHL invoices page
    const locationId = process.env.GHL_LOCATION_ID;
    invoiceUrl = `https://app.gohighlevel.com/v2/location/${locationId}/payments/invoices`;
  }
  console.log(`ðŸ”§ Constructed fallback URL: ${invoiceUrl}`);
}
```

With:
```typescript
// Fallback URL construction if needed
if (!invoiceUrl) {
  if (invoice._id && invoice._id !== 'unknown') {
    invoiceUrl = `https://api.automatosolution.com/invoice/${invoice._id}`;
    console.warn(`[FALLBACK_URL_USED] GHL Text2Pay did not return invoiceUrl. Using custom domain fallback for invoice ${invoice._id}: ${invoiceUrl}`);
  } else {
    const locationId = process.env.GHL_LOCATION_ID;
    invoiceUrl = `https://app.gohighlevel.com/v2/location/${locationId}/payments/invoices`;
    console.error(`[FALLBACK_URL_CRITICAL] GHL Text2Pay returned no invoiceUrl and no valid invoice ID. Customer will receive non-functional dashboard link: ${invoiceUrl}`);
  }
}
```

3. Delete the dead Stripe Checkout route at `src/app/api/payments/create-link/route.ts`. This file uses the old `createPaymentLink()` from `stripe.ts` and is NOT called from any frontend code (verified: no references in src/).

4. In `src/lib/integrations/stripe.ts`, remove the unused `createPaymentLink` function (lines 43-89) and its `OrderForPayment` interface (lines 23-41). Keep ALL other exports (`createPaymentIntent`, `handlePaymentSuccess`, `getPaymentStatus`, `refundPayment`, `constructWebhookEvent`, `stripe`) since they may be used by webhook handlers or other payment flows.

Do NOT modify `src/lib/ghl/invoices.ts` or any other files. The GHL integration is working correctly -- the issue is branding configuration in GHL Dashboard, not code.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors after removing dead code.
Run `grep -r "createPaymentLink\|create-link" src/ --include="*.ts" --include="*.tsx"` to confirm no remaining references to removed code.
Run `grep "FALLBACK_URL" src/app/api/payments/create-checkout/route.ts` to confirm logging tags are present.
  </verify>
  <done>
    Fallback URL logging with [FALLBACK_URL_USED] and [FALLBACK_URL_CRITICAL] tags present in create-checkout route. Dead `create-link` route deleted. Unused `createPaymentLink` and `OrderForPayment` removed from stripe.ts. TypeScript compiles clean.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure GHL Dashboard branding</name>
  <what-built>Code-side cleanup is complete (fallback logging added, dead code removed). The remaining issues â€” missing logo, wrong phone number, and ugly URLs â€” are controlled by GHL Dashboard settings, not application code.</what-built>
  <how-to-verify>
    Log into GHL Dashboard and complete these configuration steps:

    1. **Business Profile** (Settings -> Business Profile -> General Information):
       - Upload Audrey's shop logo (JPG/PNG, min 128x128px)
       - Set Business Phone to the **shop phone number** (not personal cell)
       - Verify Business Name shows "Hotte Couture"

    2. **Invoice Layout** (Payments -> Invoices & Estimates -> Settings -> Customize Layout):
       - Ensure company name, logo, and phone are visible
       - Hide any fields showing personal info
       - Optionally set Pay button text to "Payer" for French

    3. **Verify** by previewing an invoice in GHL Dashboard:
       - Logo appears in header
       - Shop phone number displays (not personal cell)
       - Business name is "Hotte Couture"

    4. **End-to-end test**: Create a test order in the app, trigger a payment request, and verify:
       - SMS/email contains a clean URL (no ugly query parameters)
       - Payment page shows correct branding (logo, phone, name)
       - Payment can be completed successfully
  </how-to-verify>
  <resume-signal>Type "dashboard configured" once GHL branding is set up, or describe any issues encountered.</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. No references to `createPaymentLink` or `create-link` route remain in `src/`
3. `[FALLBACK_URL_USED]` and `[FALLBACK_URL_CRITICAL]` log tags present in create-checkout route
4. GHL Dashboard shows correct logo, shop phone, and business name (user-verified)
5. Test invoice sent via app produces clean URL and correct branding (user-verified)
</verification>

<success_criteria>
- Fallback URL usage is logged with structured warning tags for production debugging
- Dead Stripe Checkout code removed (create-link route + createPaymentLink function)
- GHL Dashboard configured with shop logo, correct phone number, and business name
- Payment page displays professionally to customers (no ugly URLs, correct branding)
- Payment flow works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/20-stripe-payment-cleanup/20-01-SUMMARY.md`
</output>
