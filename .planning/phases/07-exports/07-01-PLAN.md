---
phase: 07-exports
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/exports/csv-utils.ts
  - src/app/api/admin/export/seamstress/route.ts
  - src/app/api/admin/export/orders/route.ts
  - src/app/api/admin/export/capacity/route.ts
autonomous: true

must_haves:
  truths:
    - "Seamstress export API returns CSV with correct columns"
    - "Orders export API returns all orders in CSV format"
    - "Capacity export API returns weekly workload per staff"
    - "CSV special characters are properly escaped"
  artifacts:
    - path: "src/lib/exports/csv-utils.ts"
      provides: "Shared CSV generation utilities"
      exports: ["escapeCsvCell", "generateCsv", "triggerDownload"]
    - path: "src/app/api/admin/export/seamstress/route.ts"
      provides: "Seamstress projects export (EXP-01, EXP-02)"
      exports: ["GET"]
    - path: "src/app/api/admin/export/orders/route.ts"
      provides: "Orders list export (EXP-03)"
      exports: ["GET"]
    - path: "src/app/api/admin/export/capacity/route.ts"
      provides: "Weekly capacity export (EXP-04)"
      exports: ["GET"]
  key_links:
    - from: "src/app/api/admin/export/seamstress/route.ts"
      to: "garment_service"
      via: "Supabase query with assigned_seamstress_id filter"
      pattern: "eq.*assigned_seamstress_id"
    - from: "src/app/api/admin/export/orders/route.ts"
      to: "order"
      via: "Supabase query for all orders"
      pattern: "from.*order.*select"
---

<objective>
Create CSV export API infrastructure with shared utilities and three export endpoints.

Purpose: Provide backend for EXP-01 through EXP-04 requirements (seamstress projects, orders list, weekly capacity exports).
Output: Three API routes returning CSV content + shared csv-utils library.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-exports/07-RESEARCH.md
@src/app/api/admin/worklist-export/route.ts
@src/lib/hooks/useStaff.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV utilities library</name>
  <files>src/lib/exports/csv-utils.ts</files>
  <action>
Create `/src/lib/exports/csv-utils.ts` with three functions:

1. `escapeCsvCell(value: any): string` - Handle null/undefined, escape commas/quotes/newlines by wrapping in double quotes and doubling internal quotes.

2. `generateCsv(headers: string[], rows: any[][]): string` - Join headers with comma, map rows through escapeCsvCell, join with newlines.

3. `triggerDownload(csvContent: string, filename: string): void` - Create Blob with text/csv charset=utf-8, createObjectURL, create anchor element, click, cleanup.

Follow the pattern from worklist-export but make it reusable. Add proper TypeScript types.
  </action>
  <verify>
File exists at `/src/lib/exports/csv-utils.ts` with all three exported functions. No TypeScript errors: `npx tsc --noEmit src/lib/exports/csv-utils.ts` (or check via IDE).
  </verify>
  <done>
CSV utilities library exports escapeCsvCell, generateCsv, and triggerDownload functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create seamstress export API (EXP-01, EXP-02)</name>
  <files>src/app/api/admin/export/seamstress/route.ts</files>
  <action>
Create `/src/app/api/admin/export/seamstress/route.ts` with GET handler:

1. Parse `seamstressId` from searchParams (return 400 if missing)

2. Query staff table for seamstress name (for filename)

3. Query garment_service with nested selects:
   - garment (type, color, actual_minutes)
   - garment.order (order_number, status, due_date, total_work_seconds)
   - garment.order.client (first_name, last_name)
   - service (name, estimated_minutes)
   Filter by: `.eq('assigned_seamstress_id', seamstressId)`

4. Build CSV with columns (EXP-02):
   - Client: `${first_name} ${last_name}`
   - Order#: order_number
   - Item: garment.type
   - Service: service.name or 'Custom'
   - Status: order.status
   - Due: format(due_date, 'yyyy-MM-dd')
   - Est Time: format as "Xh Ym" from estimated_minutes
   - Actual Time: format from actual_minutes or total_work_seconds/60

5. Sanitize seamstress name for filename (replace non-alphanumeric with underscore)

6. Return: `{ success: true, csvContent, filename: 'projects_{name}_{date}.csv' }`

Use date-fns for date formatting. Import createServiceRoleClient from @/lib/supabase/server.
  </action>
  <verify>
`curl "http://localhost:3000/api/admin/export/seamstress"` returns 400 with error message.
`curl "http://localhost:3000/api/admin/export/seamstress?seamstressId=xxx"` returns JSON with csvContent field containing headers: Client,Order#,Item,Service,Status,Due,Est Time,Actual Time
  </verify>
  <done>
Seamstress export API returns CSV with all 8 columns per EXP-02 requirements.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create orders and capacity export APIs (EXP-03, EXP-04)</name>
  <files>
    src/app/api/admin/export/orders/route.ts
    src/app/api/admin/export/capacity/route.ts
  </files>
  <action>
**Orders export (`/src/app/api/admin/export/orders/route.ts`):**

1. Query all orders (not just 'working' status like worklist-export):
   ```
   order (id, order_number, status, due_date, created_at, total_price_cents,
     client (first_name, last_name, phone, email),
     garments (type, services (quantity, service (name)))
   )
   ```
   Order by created_at DESC

2. Build CSV with columns:
   - Order#, Status, Created, Due, Client, Phone, Email, Items (count), Total ($)

3. Return: `{ success: true, csvContent, filename: 'orders_{date}.csv' }`

**Capacity export (`/src/app/api/admin/export/capacity/route.ts`):**

1. Parse optional `weekStart` from searchParams (default to current week Monday)

2. Query all active staff

3. Query orders due this week with garment_services and their assigned_seamstress_id + estimated_minutes

4. Build CSV with columns:
   - Staff Name, Assigned Items, Total Est Hours, Orders Count

5. Return: `{ success: true, csvContent, filename: 'capacity_{weekStart}_{weekEnd}.csv' }`

Both APIs: Use createServiceRoleClient, date-fns for formatting.
  </action>
  <verify>
Orders: `curl "http://localhost:3000/api/admin/export/orders"` returns JSON with csvContent containing Order#,Status,Created,Due columns.
Capacity: `curl "http://localhost:3000/api/admin/export/capacity"` returns JSON with csvContent containing Staff Name,Assigned Items columns.
  </verify>
  <done>
Orders export returns all orders in CSV format. Capacity export returns weekly workload per staff member.
  </done>
</task>

</tasks>

<verification>
1. All three API routes exist and return valid JSON responses
2. CSV content includes proper headers
3. Special characters in client names/notes are properly escaped
4. Filenames include date component
5. No TypeScript errors: `npm run build` passes
</verification>

<success_criteria>
1. csv-utils.ts exports 3 functions (escapeCsvCell, generateCsv, triggerDownload)
2. /api/admin/export/seamstress returns CSV with 8 columns per EXP-02
3. /api/admin/export/orders returns all orders (not just 'working')
4. /api/admin/export/capacity returns staff workload summary
5. All exports handle empty results gracefully (return empty CSV with headers only)
</success_criteria>

<output>
After completion, create `.planning/phases/07-exports/07-01-SUMMARY.md`
</output>
